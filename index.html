<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#079fdb">
    <title>Hexagon SAP AMS RFP | Complete Programme Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #079fdb;
            --primary-dark: #0447bb;
            --primary-light: #a1b7e2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray-50: #f8f9fa;
            --gray-100: #e9ecef;
            --gray-200: #dee2e6;
            --gray-700: #495057;
            --gray-900: #212529;
            --bg-primary: #ffffff;
            --bg-secondary: linear-gradient(135deg, #079fdb 0%, #0447bb 100%);
            --text-primary: #212529;
            --text-secondary: #495057;
            --hexagon-cyan: #079fdb;
            --hexagon-deep-blue: #0447bb;
            --hexagon-navy: #242c3c;
            --hexagon-grayish-blue: #5c74a7;
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --primary: #079fdb;
            --primary-dark: #0447bb;
            --success: #48c774;
            --warning: #ffdd57;
            --danger: #f14668;
            --gray-50: #2d2d2d;
            --gray-100: #3d3d3d;
            --gray-200: #4d4d4d;
            --gray-700: #b5b5b5;
            --gray-900: #f5f5f5;
            --bg-primary: #1a1a2e;
            --bg-secondary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --text-primary: #f5f5f5;
            --text-secondary: #b5b5b5;
        }

        [data-theme="dark"] body {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .header,
        [data-theme="dark"] .nav-tabs,
        [data-theme="dark"] .card,
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .vendor-card,
        [data-theme="dark"] .task-item,
        [data-theme="dark"] .risk-card,
        [data-theme="dark"] .folder-header,
        [data-theme="dark"] .document-item {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-textarea,
        [data-theme="dark"] .form-select {
            background: var(--gray-100);
            color: var(--text-primary);
            border-color: var(--gray-200);
        }

        [data-theme="dark"] .evaluation-table th {
            background: var(--gray-100);
            color: var(--text-primary);
        }

        [data-theme="dark"] .evaluation-table td {
            border-color: var(--gray-200);
        }

        [data-theme="dark"] .calendar-day {
            background: var(--bg-primary);
        }

        [data-theme="dark"] .filter-btn {
            background: var(--gray-100);
            color: var(--text-primary);
            border-color: var(--gray-200);
        }

        /* Skip to content link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Focus styles for accessibility */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        *:focus:not(:focus-visible) {
            outline: none;
        }

        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-900);
        }

        .container { max-width: 1600px; margin: 0 auto; }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { color: var(--primary); font-size: 2.2em; margin-bottom: 10px; }
        .header p { color: var(--gray-700); font-size: 1.1em; }
        .days-counter { font-size: 2em; font-weight: 700; color: var(--primary); }

        .nav-tabs {
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-tab:hover { background: var(--gray-200); }
        .nav-tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 10px;
        }

        .card-header h2 { color: var(--primary); font-size: 1.5em; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .grid { display: grid; gap: 20px; }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

        .stat-card {
            text-align: center;
            padding: 25px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2.8em; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 1em; }

        .task-item {
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 15px;
            align-items: center;
        }

        .task-item.completed { border-left-color: var(--success); opacity: 0.7; }
        .task-checkbox { width: 24px; height: 24px; cursor: pointer; }
        .task-title { font-weight: 600; margin-bottom: 5px; font-size: 1.05em; }
        .task-meta { font-size: 0.85em; color: var(--gray-700); }

        .phase-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            font-size: 1.1em;
        }

        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .evaluation-table th,
        .evaluation-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .evaluation-table th { background: var(--gray-100); font-weight: 600; }
        .evaluation-table tr:hover { background: var(--gray-50); }

        .editable {
            min-height: 40px;
            padding: 8px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .editable:hover { border-color: var(--primary); background: var(--gray-50); }
        .editable:focus { outline: none; border-color: var(--primary); background: white; }

        .weight-input {
            width: 80px;
            padding: 6px;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            text-align: center;
        }

        .vendor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .vendor-card {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .vendor-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,102,204,0.15); }
        .vendor-name { font-weight: 600; font-size: 1.1em; margin-bottom: 10px; }

        .vendor-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-warm { background: #e8f5e9; color: #2e7d32; }
        .status-longlist { background: #e3f2fd; color: #1976d2; }
        .status-shortlist { background: #fff9e5; color: #996600; }
        .status-finalist { background: #ffe5f0; color: #c51162; }
        .status-winner { background: #c8e6c9; color: #1b5e20; }

        .risk-card {
            border-left: 4px solid;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--gray-50);
            border-radius: 4px;
        }

        .risk-red { border-color: var(--danger); }
        .risk-amber { border-color: var(--warning); }
        .risk-green { border-color: var(--success); }

        .milestone-item {
            display: flex;
            margin-bottom: 30px;
            position: relative;
        }

        .milestone-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 20px;
            flex-shrink: 0;
        }

        .milestone-content { flex: 1; }
        .milestone-title { font-weight: 600; font-size: 1.1em; margin-bottom: 5px; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 900px;
            margin: 50px auto;
            border-radius: 12px;
            padding: 30px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: var(--gray-700);
        }

        .modal-close:hover { color: var(--gray-900); }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--gray-900); }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            font-size: 1em;
        }

        .form-textarea { min-height: 100px; resize: vertical; }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--gray-200);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Overdue and warning styles */
        .overdue {
            border-left-color: var(--danger) !important;
            background: #fff5f5 !important;
        }

        .overdue .task-title::after {
            content: ' (OVERDUE)';
            color: var(--danger);
            font-weight: 700;
            font-size: 0.8em;
        }

        .due-soon {
            border-left-color: var(--warning) !important;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: #333; }
        .toast.info { background: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Theme toggle button */
        .theme-toggle {
            background: var(--gray-100);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--gray-200);
        }

        /* Score badge */
        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9em;
        }

        .score-high { background: #e8f5e9; color: #2e7d32; }
        .score-medium { background: #fff9e5; color: #996600; }
        .score-low { background: #ffe5e5; color: #c62828; }

        /* Risk Matrix */
        .risk-matrix {
            display: grid;
            grid-template-columns: auto repeat(3, 1fr);
            gap: 2px;
            background: var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }

        .risk-matrix-cell {
            padding: 15px;
            text-align: center;
            font-size: 0.85em;
        }

        .risk-matrix-header {
            background: var(--gray-100);
            font-weight: 600;
        }

        .risk-matrix-label {
            background: var(--gray-100);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .risk-cell-high { background: #ffe5e5; }
        .risk-cell-medium { background: #fff9e5; }
        .risk-cell-low { background: #e8f5e9; }

        /* Decision Log */
        .decision-card {
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-bottom: 15px;
            background: var(--gray-50);
            border-radius: 4px;
        }

        .decision-card.approved { border-left-color: var(--success); }
        .decision-card.pending { border-left-color: var(--warning); }
        .decision-card.rejected { border-left-color: var(--danger); }

        @media print {
            body { background: white !important; padding: 0; }
            .nav-tabs, .btn, .theme-toggle, .modal { display: none !important; }
            .header { box-shadow: none; border-bottom: 2px solid #333; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; }
            .tab-content { display: block !important; page-break-before: always; }
            .tab-content:first-of-type { page-break-before: avoid; }
            .stat-card { background: #f5f5f5 !important; color: #333 !important; }
            .vendor-card, .risk-card, .task-item { page-break-inside: avoid; }
            .gantt-container { overflow: visible; }
            a { text-decoration: none; color: inherit; }
            .evaluation-table { font-size: 10pt; }
            .evaluation-table th, .evaluation-table td { padding: 8px; }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            body { padding: 10px; }
            .container { max-width: 100%; }
            .header { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .card { padding: 15px; }
            .nav-tabs { gap: 5px; padding: 8px; }
            .nav-tab { padding: 10px 16px; font-size: 0.9em; }
        }

        @media (max-width: 768px) {
            body { padding: 8px; }

            /* Header */
            .header {
                flex-direction: column;
                text-align: center;
                padding: 15px;
                gap: 15px;
            }
            .header h1 { font-size: 1.5em; margin-bottom: 5px; }
            .header p { font-size: 0.85em; line-height: 1.4; }
            .days-counter { font-size: 1.5em; }

            /* Navigation Tabs - Horizontal Scroll */
            .nav-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                gap: 6px;
                padding: 8px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                margin-bottom: 15px;
            }
            .nav-tabs::-webkit-scrollbar { display: none; }
            .nav-tab {
                white-space: nowrap;
                flex-shrink: 0;
                padding: 10px 14px;
                font-size: 0.85em;
                min-height: 44px; /* Touch-friendly */
            }

            /* Cards */
            .card {
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 8px;
            }
            .card-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .card-header h2 { font-size: 1.2em; }

            /* Dashboard Grid */
            .grid-4 { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 1.8em; }
            .stat-label { font-size: 0.85em; }

            /* Tasks */
            .task-item {
                grid-template-columns: auto 1fr;
                gap: 10px;
                padding: 12px;
            }
            .task-item > div:last-child {
                grid-column: 1 / -1;
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 8px;
            }
            .task-checkbox { width: 28px; height: 28px; }
            .task-title { font-size: 0.95em; }
            .task-meta { font-size: 0.8em; }

            /* Buttons */
            .btn {
                padding: 12px 16px;
                min-height: 44px;
                font-size: 0.9em;
            }
            .btn-small {
                padding: 10px 14px;
                min-height: 40px;
            }

            /* Vendor Grid */
            .vendor-grid { grid-template-columns: 1fr; }
            .vendor-card { padding: 15px; }

            /* Calendar */
            .calendar-grid { gap: 1px; }
            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }
            .calendar-date { font-size: 0.8em; }
            .calendar-event {
                font-size: 0.65em;
                padding: 2px 3px;
            }
            .calendar-header {
                padding: 6px;
                font-size: 0.75em;
            }
            .calendar-nav h3 { font-size: 1.1em; }

            /* Tables */
            .evaluation-table { font-size: 0.8em; }
            .evaluation-table th,
            .evaluation-table td { padding: 8px 6px; }

            /* Forms */
            .form-input, .form-textarea, .form-select {
                font-size: 16px; /* Prevents iOS zoom */
                padding: 12px;
                min-height: 44px;
            }

            /* Modals */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 10px auto;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }

            /* Phase Header */
            .phase-header {
                flex-direction: column;
                gap: 5px;
                align-items: flex-start;
                font-size: 0.9em;
            }

            /* Filter Buttons */
            .filter-btn {
                padding: 8px 12px;
                font-size: 0.8em;
                min-height: 40px;
            }

            /* Document Tree */
            .folder-header { padding: 12px; }
            .folder-name { font-size: 0.9em; }
            .document-item {
                padding: 10px;
                flex-wrap: wrap;
            }
            .doc-name {
                font-size: 0.85em;
                flex: 1 1 100%;
                margin-bottom: 8px;
            }
            .doc-actions {
                flex: 1 1 100%;
                justify-content: flex-end;
            }

            /* Meetings */
            .meeting-card { padding: 12px; }

            /* Risk Cards */
            .risk-card { padding: 12px; }

            /* GANTT - Show simplified message on mobile */
            #ganttChart > div:first-child {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            body { padding: 5px; }

            .header h1 { font-size: 1.3em; }
            .header p { font-size: 0.8em; }

            .grid-4 { grid-template-columns: 1fr; }
            .stat-card { padding: 12px; }
            .stat-value { font-size: 1.5em; }

            .nav-tab {
                padding: 8px 12px;
                font-size: 0.8em;
            }

            .card { padding: 10px; }
            .card-header h2 { font-size: 1.1em; }

            .task-item { padding: 10px; }

            .calendar-day { min-height: 50px; }
            .calendar-event { font-size: 0.6em; }

            /* Hide some text on very small screens */
            .hide-mobile { display: none; }
        }

        /* Touch-friendly improvements */
        @media (pointer: coarse) {
            .btn, .nav-tab, .filter-btn, .task-checkbox {
                min-height: 44px;
                min-width: 44px;
            }

            .theme-toggle {
                min-width: 44px;
                min-height: 44px;
            }

            /* Larger touch targets */
            .task-item { padding: 15px; }
            .document-item { padding: 12px; }
            .folder-header { padding: 14px; }
        }

        /* Landscape phone */
        @media (max-width: 896px) and (orientation: landscape) {
            .header { padding: 10px 20px; }
            .header h1 { font-size: 1.3em; }
            .days-counter { font-size: 1.3em; }
            .modal-content { max-height: 85vh; }
        }

        /* iPad specific */
        @media (min-width: 768px) and (max-width: 1024px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .vendor-grid { grid-template-columns: repeat(2, 1fr); }
            .nav-tabs { flex-wrap: wrap; }
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-header {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 8px;
            position: relative;
        }

        .calendar-day.other-month { background: var(--gray-50); opacity: 0.5; }
        .calendar-day.today { background: #e3f2fd; }

        .calendar-date {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .calendar-event {
            font-size: 0.75em;
            padding: 2px 4px;
            margin: 2px 0;
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-event.task { background: #e3f2fd; color: #1976d2; }
        .calendar-event.milestone { background: #fff9e5; color: #996600; }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav h3 { font-size: 1.3em; color: var(--primary); }

        /* Gantt Chart Styles */
        .gantt-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
        }

        .gantt-header {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .gantt-task-col {
            min-width: 250px;
            max-width: 250px;
            padding: 10px;
            font-weight: 600;
            background: var(--gray-100);
            border-right: 1px solid var(--gray-200);
        }

        .gantt-timeline {
            display: flex;
            flex: 1;
        }

        .gantt-month {
            min-width: 120px;
            padding: 10px;
            text-align: center;
            border-right: 1px solid var(--gray-200);
            font-weight: 600;
            font-size: 0.85em;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid var(--gray-100);
        }

        .gantt-task-name {
            min-width: 250px;
            max-width: 250px;
            padding: 12px 10px;
            border-right: 1px solid var(--gray-200);
            font-size: 0.9em;
        }

        .gantt-bars {
            display: flex;
            flex: 1;
            position: relative;
            align-items: center;
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 0.75em;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .gantt-bar.discovery { background: #079fdb; }
        .gantt-bar.documentation { background: #0447bb; }
        .gantt-bar.evaluation { background: #5c74a7; }
        .gantt-bar.selection { background: #242c3c; }
        .gantt-bar.milestone { background: #a1b7e2; color: #242c3c; }

        /* Document Repository Styles */
        .folder-tree {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 15px;
        }

        .folder-item {
            margin: 5px 0;
        }

        .folder-header {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .folder-header:hover { background: var(--gray-100); }

        .folder-icon { margin-right: 10px; font-size: 1.2em; }
        .folder-name { font-weight: 600; flex: 1; }
        .folder-count { font-size: 0.85em; color: var(--gray-700); }

        .folder-content {
            margin-left: 30px;
            display: none;
        }

        .folder-content.open { display: block; }

        .document-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            border-left: 3px solid var(--primary);
        }

        .document-item:hover { background: var(--gray-100); }

        .doc-icon { margin-right: 10px; }
        .doc-name { flex: 1; font-size: 0.9em; }
        .doc-status {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .doc-status.draft { background: #fff9e5; color: #996600; }
        .doc-status.review { background: #e3f2fd; color: #1976d2; }
        .doc-status.final { background: #e8f5e9; color: #2e7d32; }
        .doc-status.template { background: #fce4ec; color: #c51162; }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <header class="header" role="banner">
            <div>
                <h1>Hexagon SAP AMS RFP</h1>
                <p>Complete Programme Management Platform | Start: 8 December 2025 | <span id="appVersion" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.85em;">v1.0.0</span></p>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="theme-toggle" onclick="resetAppData()" aria-label="Reset data" title="Reset to default data (loads latest features)" style="font-size: 14px;">
                    ðŸ”„
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode" title="Toggle dark/light mode">
                    <span id="themeIcon">ðŸŒ™</span>
                </button>
                <div style="text-align: right;">
                    <div style="font-size: 0.9em; color: var(--gray-700); margin-bottom: 5px;">Programme Day</div>
                    <div class="days-counter" id="daysCounter" aria-live="polite">Day 1</div>
                </div>
            </div>
        </header>

        <nav class="nav-tabs" role="tablist" aria-label="Main navigation">
            <button class="nav-tab active" onclick="switchTab('dashboard', event)" role="tab" aria-selected="true" aria-controls="dashboard" id="tab-dashboard">Dashboard</button>
            <button class="nav-tab" onclick="switchTab('workplan', event)" role="tab" aria-selected="false" aria-controls="workplan" id="tab-workplan">Work Plan</button>
            <button class="nav-tab" onclick="switchTab('calendar', event)" role="tab" aria-selected="false" aria-controls="calendar" id="tab-calendar">Calendar</button>
            <button class="nav-tab" onclick="switchTab('gantt', event)" role="tab" aria-selected="false" aria-controls="gantt" id="tab-gantt">Gantt</button>
            <button class="nav-tab" onclick="switchTab('milestones', event)" role="tab" aria-selected="false" aria-controls="milestones" id="tab-milestones">Milestones</button>
            <button class="nav-tab" onclick="switchTab('evaluation', event)" role="tab" aria-selected="false" aria-controls="evaluation" id="tab-evaluation">Evaluation</button>
            <button class="nav-tab" onclick="switchTab('scoring', event)" role="tab" aria-selected="false" aria-controls="scoring" id="tab-scoring">Scoring</button>
            <button class="nav-tab" onclick="switchTab('vendors', event)" role="tab" aria-selected="false" aria-controls="vendors" id="tab-vendors">Vendors</button>
            <button class="nav-tab" onclick="switchTab('documents', event)" role="tab" aria-selected="false" aria-controls="documents" id="tab-documents">Documents</button>
            <button class="nav-tab" onclick="switchTab('meetings', event)" role="tab" aria-selected="false" aria-controls="meetings" id="tab-meetings">Meetings</button>
            <button class="nav-tab" onclick="switchTab('risks', event)" role="tab" aria-selected="false" aria-controls="risks" id="tab-risks">Risks</button>
            <button class="nav-tab" onclick="switchTab('decisions', event)" role="tab" aria-selected="false" aria-controls="decisions" id="tab-decisions">Decisions</button>
            <button class="nav-tab" onclick="switchTab('stakeholders', event)" role="tab" aria-selected="false" aria-controls="stakeholders" id="tab-stakeholders">Stakeholders</button>
            <button class="nav-tab" onclick="switchTab('reports', event)" role="tab" aria-selected="false" aria-controls="reports" id="tab-reports">Reports</button>
        </nav>

        <main id="main-content" role="main">

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active" role="tabpanel" aria-labelledby="tab-dashboard">
            <div class="grid grid-4">
                <div class="stat-card" onclick="switchTab('workplan', event)" role="button" tabindex="0" aria-label="View work plan - Tasks complete">
                    <div class="stat-value" id="taskProgress">0%</div>
                    <div class="stat-label">Tasks Complete</div>
                </div>
                <div class="stat-card" onclick="switchTab('vendors', event)" role="button" tabindex="0" aria-label="View vendors">
                    <div class="stat-value" id="vendorCount">13</div>
                    <div class="stat-label">Vendors Tracking</div>
                </div>
                <div class="stat-card" onclick="switchTab('milestones', event)" role="button" tabindex="0" aria-label="View milestones">
                    <div class="stat-value" id="daysToGoLive">268</div>
                    <div class="stat-label">Days to Go-Live</div>
                </div>
                <div class="stat-card" onclick="switchTab('risks', event)" role="button" tabindex="0" aria-label="View risks">
                    <div class="stat-value" id="riskCount">3</div>
                    <div class="stat-label">Active Risks</div>
                </div>
            </div>

            <!-- Overdue Warnings Banner -->
            <div id="overdueWarning" class="card" style="display: none; background: #fff5f5; border-left: 4px solid var(--danger);">
                <h3 style="color: var(--danger); margin-bottom: 10px;">Overdue Items Require Attention</h3>
                <div id="overdueList"></div>
            </div>

            <div class="card">
                <div class="card-header"><h2>Programme Status Overview</h2></div>
                <canvas id="statusChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div class="card">
                    <div class="card-header"><h2>Next 7 Days</h2></div>
                    <div id="upcomingTasks"></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>Red Risks</h2></div>
                    <div id="redRisks"></div>
                </div>
            </div>
        </div>

        <!-- Work Plan -->
        <div id="workplan" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>RFP Work Plan</h2>
                    <button class="btn btn-primary" onclick="addTask()">âž• Add Task</button>
                </div>
                <div class="filter-bar">
                    <input type="text" class="form-input" style="max-width: 300px;" placeholder="Search tasks..." id="taskSearch" oninput="renderTaskList()" aria-label="Search tasks">
                    <button class="filter-btn active" onclick="filterTasks('all', event)">All Tasks</button>
                    <button class="filter-btn" onclick="filterTasks('notstarted', event)">Not Started</button>
                    <button class="filter-btn" onclick="filterTasks('inprogress', event)">In Progress</button>
                    <button class="filter-btn" onclick="filterTasks('done', event)">Done</button>
                </div>
                <div id="taskList"></div>
            </div>
        </div>

        <!-- Calendar -->
        <div id="calendar" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Programme Calendar</h2>
                </div>
                <div class="calendar-nav">
                    <button class="btn btn-primary" onclick="changeMonth(-1)">â—€ Previous</button>
                    <h3 id="calendarTitle">December 2025</h3>
                    <button class="btn btn-primary" onclick="changeMonth(1)">Next â–¶</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: var(--gray-50); border-radius: 8px;">
                    <strong>Legend:</strong>
                    <span style="margin-left: 15px; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px;">Tasks</span>
                    <span style="margin-left: 10px; padding: 4px 8px; background: #fff9e5; color: #996600; border-radius: 4px;">Milestones</span>
                </div>
            </div>
        </div>

        <!-- Gantt Chart -->
        <div id="gantt" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Gantt Chart - Programme Timeline</h2>
                </div>
                <div style="margin-bottom: 15px; padding: 10px; background: var(--gray-50); border-radius: 8px;">
                    <strong>Phase Legend:</strong>
                    <span style="margin-left: 15px; padding: 4px 12px; background: #079fdb; color: white; border-radius: 4px;">Discovery</span>
                    <span style="margin-left: 10px; padding: 4px 12px; background: #0447bb; color: white; border-radius: 4px;">Documentation</span>
                    <span style="margin-left: 10px; padding: 4px 12px; background: #5c74a7; color: white; border-radius: 4px;">Evaluation</span>
                    <span style="margin-left: 10px; padding: 4px 12px; background: #242c3c; color: white; border-radius: 4px;">Selection</span>
                    <span style="margin-left: 10px; padding: 4px 12px; background: #a1b7e2; color: #242c3c; border-radius: 4px;">Milestone</span>
                </div>
                <div class="gantt-container" id="ganttChart"></div>
            </div>
        </div>

        <!-- Milestones -->
        <div id="milestones" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Programme Milestones</h2>
                    <button class="btn btn-primary" onclick="addMilestone()">âž• Add Milestone</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="milestoneProgress">0%</div>
                </div>
                <div id="milestoneList"></div>
            </div>
        </div>

        <!-- Evaluation -->
        <div id="evaluation" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Evaluation Framework (Editable)</h2>
                    <div>
                        <button class="btn btn-success" onclick="saveEvaluation()">ðŸ’¾ Save Framework</button>
                        <button class="btn btn-primary" onclick="addCriterion()">âž• Add Criterion</button>
                    </div>
                </div>
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Criterion</th>
                            <th style="width: 10%;">Weight</th>
                            <th style="width: 30%;">What Good Looks Like</th>
                            <th style="width: 30%;">Red Flags</th>
                            <th style="width: 10%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="criteriaBody"></tbody>
                </table>
                <div style="margin-top: 20px; padding: 15px; background: var(--gray-50); border-radius: 8px;">
                    <strong>Total Weight:</strong> <span id="totalWeight">100</span> points
                </div>
            </div>
        </div>

        <!-- Vendors -->
        <div id="vendors" class="tab-content" role="tabpanel" aria-labelledby="tab-vendors">
            <div class="card">
                <div class="card-header">
                    <h2>Vendor Management</h2>
                    <button class="btn btn-primary" onclick="openVendorModal()" aria-label="Add new vendor">+ Add Vendor</button>
                </div>
                <div class="filter-bar">
                    <input type="text" class="form-input" style="max-width: 300px;" placeholder="Search vendors..." id="vendorSearch" oninput="renderVendorGrid()" aria-label="Search vendors">
                    <button class="filter-btn active" onclick="filterVendors('all', event)">All Vendors</button>
                    <button class="filter-btn" onclick="filterVendors('tier1', event)">Tier 1</button>
                    <button class="filter-btn" onclick="filterVendors('tier2', event)">Tier 2</button>
                    <button class="filter-btn" onclick="filterVendors('warm', event)">Warm Leads</button>
                    <button class="filter-btn" onclick="filterVendors('shortlist', event)">Shortlist</button>
                </div>
                <div class="vendor-grid" id="vendorGrid" role="list"></div>
            </div>
        </div>

        <!-- Vendor Scoring -->
        <div id="scoring" class="tab-content" role="tabpanel" aria-labelledby="tab-scoring">
            <div class="card">
                <div class="card-header">
                    <h2>Vendor Scorecard</h2>
                    <div>
                        <button class="btn btn-success" onclick="saveScores()">Save Scores</button>
                        <button class="btn btn-primary" onclick="generateScoreReport()">Generate Report</button>
                    </div>
                </div>
                <p style="margin-bottom: 20px; color: var(--gray-700);">Score each vendor against evaluation criteria (0-10 scale). Weighted scores are calculated automatically.</p>
                <div style="overflow-x: auto;">
                    <table class="evaluation-table" id="scoringTable">
                        <thead id="scoringHeader"></thead>
                        <tbody id="scoringBody"></tbody>
                    </table>
                </div>
                <div id="scoringSummary" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Documents -->
        <div id="documents" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Document Repository</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="openUploadModal()">ðŸ“¤ Upload Document</button>
                        <button class="btn btn-primary" onclick="addDocument()">âž• Add Document</button>
                    </div>
                </div>
                <div class="folder-tree" id="documentTree"></div>
            </div>
        </div>

        <!-- Meetings -->
        <div id="meetings" class="tab-content" role="tabpanel" aria-labelledby="tab-meetings">
            <div class="card">
                <div class="card-header">
                    <h2>Meeting Calendar</h2>
                    <button class="btn btn-primary" onclick="openMeetingModal()">âž• Add Meeting</button>
                </div>
                <div class="calendar-nav">
                    <button class="btn btn-primary" onclick="changeMeetingMonth(-1)">â—€ Previous</button>
                    <h3 id="meetingCalendarTitle">December 2025</h3>
                    <button class="btn btn-primary" onclick="changeMeetingMonth(1)">Next â–¶</button>
                </div>
                <div class="calendar-grid" id="meetingCalendarGrid">
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: var(--gray-50); border-radius: 8px;">
                    <strong>Legend:</strong>
                    <span style="margin-left: 15px; padding: 4px 8px; background: #e8d5ff; color: #764ba2; border-radius: 4px;">Meetings</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Upcoming Meetings</h2>
                </div>
                <div id="meetingsList"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Meeting Notes</h2>
                    <button class="btn btn-primary" onclick="openMeetingNotesModal()">ðŸ“¤ Upload Notes</button>
                </div>
                <div id="meetingNotesList"></div>
            </div>
        </div>

        <!-- Risks -->
        <div id="risks" class="tab-content" role="tabpanel" aria-labelledby="tab-risks">
            <div class="card">
                <div class="card-header">
                    <h2>Risk Register</h2>
                    <button class="btn btn-primary" onclick="openRiskModal()" aria-label="Add new risk">+ Add Risk</button>
                </div>
                <div id="riskList"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Risk Matrix</h2>
                </div>
                <p style="margin-bottom: 15px; color: var(--gray-700);">Visual representation of risks by probability and impact.</p>
                <div class="risk-matrix" id="riskMatrix">
                    <div class="risk-matrix-cell"></div>
                    <div class="risk-matrix-cell risk-matrix-header">Low Impact</div>
                    <div class="risk-matrix-cell risk-matrix-header">Medium Impact</div>
                    <div class="risk-matrix-cell risk-matrix-header">High Impact</div>

                    <div class="risk-matrix-cell risk-matrix-label">High Probability</div>
                    <div class="risk-matrix-cell risk-cell-medium" id="matrix-high-low"></div>
                    <div class="risk-matrix-cell risk-cell-high" id="matrix-high-med"></div>
                    <div class="risk-matrix-cell risk-cell-high" id="matrix-high-high"></div>

                    <div class="risk-matrix-cell risk-matrix-label">Medium Probability</div>
                    <div class="risk-matrix-cell risk-cell-low" id="matrix-med-low"></div>
                    <div class="risk-matrix-cell risk-cell-medium" id="matrix-med-med"></div>
                    <div class="risk-matrix-cell risk-cell-high" id="matrix-med-high"></div>

                    <div class="risk-matrix-cell risk-matrix-label">Low Probability</div>
                    <div class="risk-matrix-cell risk-cell-low" id="matrix-low-low"></div>
                    <div class="risk-matrix-cell risk-cell-low" id="matrix-low-med"></div>
                    <div class="risk-matrix-cell risk-cell-medium" id="matrix-low-high"></div>
                </div>
            </div>
        </div>

        <!-- Decision Log -->
        <div id="decisions" class="tab-content" role="tabpanel" aria-labelledby="tab-decisions">
            <div class="card">
                <div class="card-header">
                    <h2>Decision Log</h2>
                    <button class="btn btn-primary" onclick="openDecisionModal()" aria-label="Add new decision">+ Add Decision</button>
                </div>
                <p style="margin-bottom: 20px; color: var(--gray-700);">Track key programme decisions, rationale, and outcomes.</p>
                <div id="decisionList"></div>
            </div>
        </div>

        <!-- Stakeholders -->
        <div id="stakeholders" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Stakeholder Management</h2>
                    <button class="btn btn-primary" onclick="addStakeholder()">âž• Add Stakeholder</button>
                </div>
                <div class="vendor-grid" id="stakeholderGrid"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>RACI Matrix</h2>
                    <button class="btn btn-success" onclick="saveRaci()">ðŸ’¾ Save RACI</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="evaluation-table" id="raciTable">
                        <thead>
                            <tr id="raciHeader">
                                <th style="min-width: 200px;">Activity / Deliverable</th>
                                <!-- Stakeholder columns added dynamically -->
                            </tr>
                        </thead>
                        <tbody id="raciBody"></tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: var(--gray-50); border-radius: 8px;">
                    <strong>Legend:</strong>
                    <span style="margin-left: 15px; padding: 4px 8px; background: #e3f2fd; border-radius: 4px;">R = Responsible</span>
                    <span style="margin-left: 10px; padding: 4px 8px; background: #fff9e5; border-radius: 4px;">A = Accountable</span>
                    <span style="margin-left: 10px; padding: 4px 8px; background: #e8f5e9; border-radius: 4px;">C = Consulted</span>
                    <span style="margin-left: 10px; padding: 4px 8px; background: #fce4ec; border-radius: 4px;">I = Informed</span>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="addRaciActivity()">âž• Add Activity</button>
                </div>
            </div>
        </div>

        <!-- Reports -->
        <div id="reports" class="tab-content" role="tabpanel" aria-labelledby="tab-reports">
            <div class="card">
                <div class="card-header"><h2>Report Generator</h2></div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateStatusReport()">Status Report</button>
                    <button class="btn btn-primary" onclick="generateVendorReport()">Vendor Analysis</button>
                    <button class="btn btn-primary" onclick="generateRiskReport()">Risk Report</button>
                    <button class="btn btn-primary" onclick="generateScoreReport()">Scoring Report</button>
                </div>
                <div id="reportOutput"></div>
                <div style="margin-top: 20px; padding: 15px; background: var(--gray-50); border-radius: 8px;">
                    <strong>Export Report:</strong>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="exportToWord()">ðŸ“„ Export to Word (.docx)</button>
                        <button class="btn btn-success" onclick="exportToPowerPoint()">ðŸ“½ï¸ Export to PowerPoint (.pptx)</button>
                        <button class="btn btn-success" onclick="printReport()">ðŸ–¨ï¸ Print Report</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>Data Management</h2></div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-success" onclick="exportData()">Export Data (JSON)</button>
                    <label class="btn btn-primary" style="cursor: pointer;">
                        Import Data (JSON)
                        <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
                    </label>
                    <button class="btn btn-danger" onclick="resetToDefaults()">Reset to Defaults</button>
                </div>
                <p style="margin-top: 15px; color: var(--gray-700); font-size: 0.9em;">
                    Export creates a backup of all your data. Import restores from a previously exported file.
                </p>
            </div>
        </div>

        </main>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('taskModal')">&times;</span>
            <h2 id="taskModalTitle">Add New Task</h2>
            
            <div class="form-group">
                <label class="form-label">Task Name</label>
                <input type="text" class="form-input" id="taskName">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="taskDescription"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Owner</label>
                    <input type="text" class="form-input" id="taskOwner">
                </div>

                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="taskDueDate">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="taskStatus">
                    <option value="notstarted">Not Started</option>
                    <option value="inprogress">In Progress</option>
                    <option value="done">Done</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Phase</label>
                <select class="form-select" id="taskPhase">
                    <option value="discovery">Discovery & Strategy</option>
                    <option value="documentation">RFP Documentation</option>
                    <option value="evaluation">Evaluation & Selection</option>
                    <option value="selection">Final Selection & Award</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
        </div>
    </div>

    <!-- Vendor Modal -->
    <div id="vendorModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('vendorModal')">&times;</span>
            <h2 id="vendorModalTitle">Add New Vendor</h2>
            <div class="form-group">
                <label class="form-label" for="vendorName">Vendor Name *</label>
                <input type="text" class="form-input" id="vendorName" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label" for="vendorType">Type</label>
                    <input type="text" class="form-input" id="vendorType" placeholder="e.g., Global SI">
                </div>
                <div class="form-group">
                    <label class="form-label" for="vendorTier">Tier</label>
                    <select class="form-select" id="vendorTier">
                        <option value="Tier 1">Tier 1</option>
                        <option value="Tier 2">Tier 2</option>
                        <option value="Mid">Mid-tier</option>
                        <option value="Niche">Niche</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="vendorStrengths">Key Strengths</label>
                <textarea class="form-textarea" id="vendorStrengths"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="vendorRelevance">Hexagon Relevance</label>
                <textarea class="form-textarea" id="vendorRelevance"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveVendor()">Save Vendor</button>
        </div>
    </div>

    <!-- Risk Modal -->
    <div id="riskModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('riskModal')">&times;</span>
            <h2 id="riskModalTitle">Add New Risk</h2>
            <div class="form-group">
                <label class="form-label" for="riskName">Risk Description *</label>
                <input type="text" class="form-input" id="riskName" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="riskImpact">Impact</label>
                <textarea class="form-textarea" id="riskImpact"></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label" for="riskOwner">Owner</label>
                    <input type="text" class="form-input" id="riskOwner">
                </div>
                <div class="form-group">
                    <label class="form-label" for="riskDueDate">Due Date</label>
                    <input type="date" class="form-input" id="riskDueDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="riskRag">RAG Status</label>
                    <select class="form-select" id="riskRag">
                        <option value="red">Red</option>
                        <option value="amber" selected>Amber</option>
                        <option value="green">Green</option>
                    </select>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label" for="riskProbability">Probability</label>
                    <select class="form-select" id="riskProbability">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="riskImpactLevel">Impact Level</label>
                    <select class="form-select" id="riskImpactLevel">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="riskMitigation">Mitigation</label>
                <textarea class="form-textarea" id="riskMitigation"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveRisk()">Save Risk</button>
        </div>
    </div>

    <!-- Decision Modal -->
    <div id="decisionModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('decisionModal')">&times;</span>
            <h2>Add New Decision</h2>
            <div class="form-group">
                <label class="form-label" for="decisionTitle">Decision Title *</label>
                <input type="text" class="form-input" id="decisionTitle" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="decisionDescription">Description</label>
                <textarea class="form-textarea" id="decisionDescription"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="decisionRationale">Rationale</label>
                <textarea class="form-textarea" id="decisionRationale"></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label" for="decisionOwner">Decision Maker</label>
                    <input type="text" class="form-input" id="decisionOwner">
                </div>
                <div class="form-group">
                    <label class="form-label" for="decisionDate">Date</label>
                    <input type="date" class="form-input" id="decisionDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="decisionStatus">Status</label>
                    <select class="form-select" id="decisionStatus">
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveDecision()">Save Decision</button>
        </div>
    </div>

    <!-- Milestone Modal -->
    <div id="milestoneModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('milestoneModal')">&times;</span>
            <h2>Add New Milestone</h2>
            <div class="form-group">
                <label class="form-label" for="milestoneTitle">Milestone Title *</label>
                <input type="text" class="form-input" id="milestoneTitle" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="milestoneDate">Target Date</label>
                <input type="date" class="form-input" id="milestoneDate">
            </div>
            <button class="btn btn-primary" onclick="saveMilestone()">Save Milestone</button>
        </div>
    </div>

    <!-- Stakeholder Modal -->
    <div id="stakeholderModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('stakeholderModal')">&times;</span>
            <h2>Add New Stakeholder</h2>
            <div class="form-group">
                <label class="form-label" for="stakeholderName">Name/Title *</label>
                <input type="text" class="form-input" id="stakeholderName" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label" for="stakeholderRole">Role</label>
                    <input type="text" class="form-input" id="stakeholderRole">
                </div>
                <div class="form-group">
                    <label class="form-label" for="stakeholderDept">Department</label>
                    <input type="text" class="form-input" id="stakeholderDept">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label" for="stakeholderInfluence">Influence</label>
                    <select class="form-select" id="stakeholderInfluence">
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="stakeholderInterest">Interest</label>
                    <select class="form-select" id="stakeholderInterest">
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="stakeholderNotes">Notes</label>
                <textarea class="form-textarea" id="stakeholderNotes"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveStakeholder()">Save Stakeholder</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content" style="max-width: 400px;">
            <h2>Confirm Action</h2>
            <p id="confirmMessage" style="margin: 20px 0;"></p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeModal('confirmModal')" style="background: var(--gray-200);">Cancel</button>
                <button class="btn btn-danger" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Meeting Modal -->
    <div id="meetingModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('meetingModal')">&times;</span>
            <h2 id="meetingModalTitle">Add New Meeting</h2>
            <div class="form-group">
                <label class="form-label" for="meetingTitle">Meeting Title *</label>
                <input type="text" class="form-input" id="meetingTitle" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label" for="meetingDate">Date *</label>
                    <input type="date" class="form-input" id="meetingDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="meetingTime">Time</label>
                    <input type="time" class="form-input" id="meetingTime">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label" for="meetingDuration">Duration (hours)</label>
                    <input type="number" class="form-input" id="meetingDuration" min="0.5" step="0.5" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="meetingLocation">Location</label>
                    <input type="text" class="form-input" id="meetingLocation" placeholder="Room / Teams / Zoom">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label" for="meetingAttendees">Attendees</label>
                <input type="text" class="form-input" id="meetingAttendees" placeholder="e.g., CIO, Procurement Director, Finance">
            </div>
            <div class="form-group">
                <label class="form-label" for="meetingAgenda">Agenda</label>
                <textarea class="form-textarea" id="meetingAgenda" placeholder="Meeting topics and objectives..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="meetingType">Meeting Type</label>
                <select class="form-select" id="meetingType">
                    <option value="internal">Internal</option>
                    <option value="vendor">Vendor Meeting</option>
                    <option value="steering">Steering Committee</option>
                    <option value="workshop">Workshop</option>
                    <option value="review">Review Meeting</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="saveMeeting()">Save Meeting</button>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div id="uploadModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('uploadModal')">&times;</span>
            <h2>Upload Document</h2>
            <div class="form-group">
                <label class="form-label" for="uploadFolder">Select Folder *</label>
                <select class="form-select" id="uploadFolder">
                    <option value="discovery">1. Discovery & Strategy</option>
                    <option value="documentation">2. RFP Documentation</option>
                    <option value="evaluation">3. Evaluation & Selection</option>
                    <option value="selection">4. Final Selection & Award</option>
                    <option value="governance">5. Programme Governance</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="uploadFile">Select File *</label>
                <input type="file" class="form-input" id="uploadFile" accept=".doc,.docx,.xls,.xlsx,.ppt,.pptx,.pdf,.txt,.csv" style="padding: 10px;">
            </div>
            <div class="form-group">
                <label class="form-label" for="uploadStatus">Document Status</label>
                <select class="form-select" id="uploadStatus">
                    <option value="draft">Draft</option>
                    <option value="template">Template</option>
                    <option value="final">Final</option>
                </select>
            </div>
            <div style="background: var(--gray-50); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="font-size: 0.9em; color: var(--gray-700);">
                    <strong>Note:</strong> Files are stored securely in the cloud (up to 50MB). Supported formats: Word, Excel, PowerPoint, PDF, Text, CSV.
                </p>
            </div>
            <button class="btn btn-primary" onclick="uploadDocument()">ðŸ“¤ Upload Document</button>
        </div>
    </div>

    <!-- Meeting Notes Upload Modal -->
    <div id="meetingNotesModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('meetingNotesModal')">&times;</span>
            <h2>Upload Meeting Notes</h2>
            <div class="form-group">
                <label class="form-label" for="notesTitle">Title *</label>
                <input type="text" class="form-input" id="notesTitle" placeholder="e.g., Kickoff Meeting Notes - 8 Dec 2025">
            </div>
            <div class="form-group">
                <label class="form-label" for="notesMeeting">Related Meeting</label>
                <select class="form-select" id="notesMeeting">
                    <option value="">-- Select Meeting (Optional) --</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="notesFile">Upload File</label>
                <input type="file" class="form-input" id="notesFile" accept=".doc,.docx,.pdf,.txt,.md" style="padding: 10px;">
            </div>
            <div class="form-group">
                <label class="form-label" for="notesContent">Or Enter Notes Directly</label>
                <textarea class="form-textarea" id="notesContent" rows="8" placeholder="Type meeting notes here..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="notesDate">Date</label>
                <input type="date" class="form-input" id="notesDate">
            </div>
            <button class="btn btn-primary" onclick="saveMeetingNotes()">ðŸ’¾ Save Notes</button>
        </div>
    </div>

    <script>
        // Initial Data from Hexagon Excel File
        const INITIAL_DATA = {
            tasks: [
                {id: 1, name: "Kick-off & Data Gathering", owner: "CIO / Procurement Director", dueDate: "2025-12-08", status: "notstarted", phase: "discovery", description: "Validated Project Plan - Confirm access to Deloitte Report"},
                {id: 2, name: "Deep Dive: Deloitte Report", owner: "Self / Deloitte Rep", dueDate: "2025-12-09", status: "notstarted", phase: "discovery", description: "Gap Analysis Summary - Identify missing ticket data"},
                {id: 3, name: "Stakeholder Interviews (USA Focus)", owner: "USA Ops Lead / CIO", dueDate: "2025-12-10", status: "notstarted", phase: "discovery", description: "USA Requirements List - Focus on June vs Sept impact"},
                {id: 4, name: "Stakeholder Interviews (Global)", owner: "CFO / Global Procurement", dueDate: "2025-12-11", status: "notstarted", phase: "discovery", description: "Commercial Constraints - Define Budget Envelope"},
                {id: 5, name: "Draft Selection Questionnaire (SQ)", owner: "Self", dueDate: "2025-12-12", status: "notstarted", phase: "documentation", description: "Draft SQ V0.1"},
                {id: 6, name: "Market Engagement (Soft Sounding)", owner: "Potential Vendors", dueDate: "2025-12-15", status: "notstarted", phase: "discovery", description: "Vendor Interest Heatmap - Gauge appetite for timeline"},
                {id: 7, name: "Market Engagement (Incumbent)", owner: "Current SAP Partner", dueDate: "2025-12-16", status: "notstarted", phase: "discovery", description: "Incumbent Strategy Notes - Careful comms management"},
                {id: 8, name: "Finalize SQ & Long List", owner: "Procurement Director", dueDate: "2025-12-17", status: "notstarted", phase: "documentation", description: "Approved SQ & List - Milestone Decision"},
                {id: 9, name: "Draft Sourcing Strategy (Skeleton)", owner: "Self", dueDate: "2025-12-18", status: "notstarted", phase: "documentation", description: "Strategy V0.1"},
                {id: 10, name: "Commercial Model Modelling", owner: "Finance", dueDate: "2025-12-19", status: "notstarted", phase: "documentation", description: "Pricing Template Draft - Fixed vs Variable validation"},
                {id: 11, name: "Review Strategy with CIO", owner: "CIO", dueDate: "2025-12-22", status: "notstarted", phase: "documentation", description: "Feedback on Strategy"},
                {id: 12, name: "Refine Strategy & RFP Roadmap", owner: "Self", dueDate: "2025-12-23", status: "notstarted", phase: "documentation", description: "Strategy V0.2"},
                {id: 13, name: "Final Strategy Pack Creation", owner: "Self", dueDate: "2025-12-29", status: "notstarted", phase: "documentation", description: "Final Sourcing Strategy"},
                {id: 14, name: "Executive Sign-off Meeting", owner: "CIO / CFO", dueDate: "2025-12-30", status: "notstarted", phase: "documentation", description: "Signed Approval"},
                {id: 15, name: "RFP Readiness Check", owner: "Self", dueDate: "2025-12-31", status: "notstarted", phase: "documentation", description: "RFP Launch Pack Ready - Ready for Jan launch"},
                {id: 16, name: "Issue Selection Questionnaire", owner: "Procurement Director", dueDate: "2026-01-05", status: "notstarted", phase: "evaluation", description: "Send SQ to long-listed vendors"},
                {id: 17, name: "SQ Response Collection", owner: "Programme Lead", dueDate: "2026-01-20", status: "notstarted", phase: "evaluation", description: "Collect and log all vendor SQ responses"},
                {id: 18, name: "SQ Evaluation & Scoring", owner: "Evaluation Team", dueDate: "2026-01-25", status: "notstarted", phase: "evaluation", description: "Score SQ responses against criteria"},
                {id: 19, name: "Shortlist Decision Meeting", owner: "CIO / Procurement Director", dueDate: "2026-01-30", status: "notstarted", phase: "evaluation", description: "Select 5-6 vendors for final RFP"},
                {id: 20, name: "Final RFP Document Preparation", owner: "Self", dueDate: "2026-02-01", status: "notstarted", phase: "evaluation", description: "Prepare detailed RFP for shortlist"},
                {id: 21, name: "Issue Final RFP to Shortlist", owner: "Procurement Director", dueDate: "2026-02-05", status: "notstarted", phase: "evaluation", description: "Send RFP to shortlisted vendors"},
                {id: 22, name: "Vendor Q&A Period", owner: "Programme Lead", dueDate: "2026-02-20", status: "notstarted", phase: "evaluation", description: "Manage vendor clarification questions"},
                {id: 23, name: "RFP Response Collection", owner: "Programme Lead", dueDate: "2026-03-01", status: "notstarted", phase: "evaluation", description: "Collect final RFP responses"},
                {id: 24, name: "Technical Evaluation", owner: "IT Ops Manager", dueDate: "2026-03-07", status: "notstarted", phase: "evaluation", description: "Technical assessment of proposals"},
                {id: 25, name: "Commercial Evaluation", owner: "Finance / Procurement", dueDate: "2026-03-10", status: "notstarted", phase: "evaluation", description: "Commercial and pricing analysis"},
                {id: 26, name: "Vendor Presentations Week 1", owner: "Evaluation Team", dueDate: "2026-03-12", status: "notstarted", phase: "evaluation", description: "First round of vendor presentations"},
                {id: 27, name: "Vendor Presentations Week 2", owner: "Evaluation Team", dueDate: "2026-03-15", status: "notstarted", phase: "evaluation", description: "Second round of vendor presentations"},
                {id: 28, name: "Reference Checks", owner: "Procurement Director", dueDate: "2026-03-25", status: "notstarted", phase: "selection", description: "Contact vendor references"},
                {id: 29, name: "Final Evaluation Consolidation", owner: "Programme Lead", dueDate: "2026-04-01", status: "notstarted", phase: "selection", description: "Consolidate all evaluation scores"},
                {id: 30, name: "Selection Recommendation", owner: "Evaluation Team", dueDate: "2026-04-10", status: "notstarted", phase: "selection", description: "Prepare recommendation for executives"},
                {id: 31, name: "Executive Decision Meeting", owner: "CIO / CFO", dueDate: "2026-04-15", status: "notstarted", phase: "selection", description: "Final vendor selection decision"},
                {id: 32, name: "Contract Negotiations", owner: "Procurement Director / Legal", dueDate: "2026-04-25", status: "notstarted", phase: "selection", description: "Negotiate final contract terms"},
                {id: 33, name: "Contract Signature", owner: "CIO / CFO", dueDate: "2026-04-30", status: "notstarted", phase: "selection", description: "Sign AMS contract with selected vendor"},
                {id: 34, name: "Transition Kick-off", owner: "Programme Lead", dueDate: "2026-05-05", status: "notstarted", phase: "selection", description: "Begin transition planning with vendor"},
                {id: 35, name: "Knowledge Transfer Phase 1", owner: "IT Ops Manager", dueDate: "2026-05-30", status: "notstarted", phase: "selection", description: "Initial knowledge transfer sessions"},
                {id: 36, name: "Knowledge Transfer Phase 2", owner: "IT Ops Manager", dueDate: "2026-06-30", status: "notstarted", phase: "selection", description: "Advanced knowledge transfer and handover"},
                {id: 37, name: "Hypercare Planning", owner: "Programme Lead", dueDate: "2026-07-15", status: "notstarted", phase: "selection", description: "Plan hypercare support model"},
                {id: 38, name: "Pre-Go-Live Readiness", owner: "IT Ops Manager", dueDate: "2026-08-15", status: "notstarted", phase: "selection", description: "Verify all systems ready for transition"},
                {id: 39, name: "Mobilisation Complete", owner: "Programme Lead", dueDate: "2026-08-31", status: "notstarted", phase: "selection", description: "Full mobilisation of new AMS team"},
                {id: 40, name: "US Go-Live Support", owner: "New AMS Vendor", dueDate: "2026-09-01", status: "notstarted", phase: "selection", description: "Hypercare support for US Go-Live"}
            ],
            vendors: [
                {id: 1, name: "Accenture", type: "Global SI", tier: "Tier 1", strengths: "Market leader in S/4HANA. Massive scale. 'Soar with Accenture' methodology.", relevance: "Deep expertise in High Tech & Manufacturing industries.", status: "longlist"},
                {id: 2, name: "Deloitte", type: "Global SI", tier: "Tier 1", strengths: "Strong on Business Transformation. Often already in the C-suite.", relevance: "Author of your Due Diligence Report (High Context).", status: "warm"},
                {id: 3, name: "Capgemini", type: "Global SI", tier: "Tier 1", strengths: "Very strong in Europe/Manufacturing. Focus on 'Intelligent Enterprise'.", relevance: "Excellent track record in discrete manufacturing.", status: "longlist"},
                {id: 4, name: "NTT DATA", type: "Global SI", tier: "Tier 2", strengths: "Strategic Note: Known partner for Hexagon's own products (HxGN EAM).", relevance: "High Synergy. They may already know Hexagon's ecosystem.", status: "warm"},
                {id: 5, name: "Infosys", type: "Global SI", tier: "Tier 1", strengths: "Strong on cost-optimization and AI automation (Infosys Cobalt).", relevance: "Good for 'keeping the lights on' at lower cost.", status: "longlist"},
                {id: 6, name: "TCS", type: "Global SI", tier: "Tier 1", strengths: "Massive scale, very process-driven. 'Perpetual Beta' model.", relevance: "Strong in Engineering & Industrial services.", status: "longlist"},
                {id: 7, name: "HCLTech", type: "Global SI", tier: "Tier 2", strengths: "'Engineering DNA'. Very strong in technical SAP landscape management.", relevance: "Culturally fits Hexagon's engineering background.", status: "longlist"},
                {id: 8, name: "IBM Consulting", type: "Tech Giant", tier: "Tier 1", strengths: "'Rise with SAP' premium partner. Deep AI/Watson integration capabilities.", relevance: "Heritage in complex legacy-to-cloud migrations.", status: "longlist"},
                {id: 9, name: "SAP (DBS)", type: "OEM", tier: "Tier 1", strengths: "SAP's own 'Digital Business Services' (MaxAttention).", relevance: "Highest cost, but 100% proximity to product dev.", status: "longlist"},
                {id: 10, name: "Lemongrass", type: "Boutique", tier: "Niche", strengths: "'SAP on Cloud' specialists (esp. AWS). Very technical, less functional.", relevance: "If Hexagon is moving SAP to AWS/Azure, they are top tier.", status: "longlist"},
                {id: 11, name: "BirlaSoft", type: "Boutique", tier: "Mid", strengths: "Strong in Manufacturing and Energy. 'Challenger' status.", relevance: "Good agile alternative to the Big 4.", status: "longlist"},
                {id: 12, name: "LTIMindtree", type: "Global SI", tier: "Mid", strengths: "'Challenger' to the big players. Agile and hungry for deals.", relevance: "Good balance of size vs. attention.", status: "longlist"},
                {id: 13, name: "Wipro", type: "Global SI", tier: "Tier 2", strengths: "Recognized for significant growth in SAP S/4HANA revenue recently.", relevance: "Strong presence in US markets.", status: "longlist"}
            ],
            risks: [
                {id: 1, risk: "SAP USA Go-Live Date", impact: "Critical. If moves to Sept, transition period extends.", owner: "CIO / Program Lead", dueDate: "2025-12-15", rag: "red", mitigation: "Need Scenario A (June) and B (Sept) in RFP", probability: "high", impactLevel: "high"},
                {id: 2, risk: "Access to Ticket Data", impact: "High. Vendors cannot price without ticket volumes.", owner: "IT Ops", dueDate: "2025-12-10", rag: "amber", mitigation: "Extract from ServiceNow/Jira", probability: "medium", impactLevel: "high"},
                {id: 3, risk: "Deloitte Report Access", impact: "Medium. Delays Gap Analysis.", owner: "CIO Office", dueDate: "2025-12-08", rag: "green", mitigation: "Chase Monday AM", probability: "low", impactLevel: "medium"}
            ],
            decisions: [
                {id: 1, title: "RFP Timeline Confirmed", description: "Agreed on 9-month programme timeline", rationale: "Balances speed with thoroughness", owner: "CIO", date: "2025-12-08", status: "approved"}
            ],
            vendorScores: {},
            milestones: [
                {id: 1, title: "Discovery Phase Complete", date: "2025-12-31", status: "notstarted"},
                {id: 2, title: "Selection Questionnaire Issued", date: "2026-01-05", status: "notstarted"},
                {id: 3, title: "Shortlist Selected (13 â†’ 5-6)", date: "2026-01-30", status: "notstarted"},
                {id: 4, title: "Final RFP Issued to Shortlist", date: "2026-02-01", status: "notstarted"},
                {id: 5, title: "Vendor Presentations Complete", date: "2026-03-15", status: "notstarted"},
                {id: 6, title: "Contract Signed", date: "2026-04-30", status: "notstarted"},
                {id: 7, title: "Mobilisation Complete", date: "2026-08-31", status: "notstarted"},
                {id: 8, title: "US Go-Live", date: "2026-09-01", status: "notstarted"}
            ],
            evaluation: [
                {id: 1, criterion: "Transition Capability", weight: 25, goodLooks: "Detailed knowledge transfer plan, named transition manager, 30-day handover timeline", redFlags: "Vague 'we'll work it out', no transition plan, assumes implementation was perfect"},
                {id: 2, criterion: "Hypercare Delivery Model", weight: 25, goodLooks: "Named senior resources, on-ground presence, 24/7 escalation with real SAP experts", redFlags: "Offshore-heavy, 'we'll assign someone', no named resources in proposal"},
                {id: 3, criterion: "Global Scalability", weight: 20, goodLooks: "US-first model that expands modularly, clear pricing per region, flexible contracts", redFlags: "All-or-nothing global commitment, 3-5 year lock-in, single global price"},
                {id: 4, criterion: "Post-Implementation Track Record", weight: 15, goodLooks: "3+ AMS references for similar deployments, renewal rates >80%, specific to support", redFlags: "'We've done many SAP implementations' without AMS examples"},
                {id: 5, criterion: "Commercial Model", weight: 10, goodLooks: "Transparent pricing, clear support vs. enhancement boundary, reasonable SLAs with teeth", redFlags: "Everything is 'enhancement' (extra cost), vague SLAs, no penalty clauses"},
                {id: 6, criterion: "Value Beyond Support", weight: 5, goodLooks: "Proactive optimisation examples, continuous improvement methodology, release management", redFlags: "Break-fix mentality only, reactive not proactive"}
            ],
            stakeholders: [
                {id: 1, name: "CIO", role: "Executive Sponsor", department: "IT Leadership", email: "", influence: "high", interest: "high", notes: "Ultimate decision maker for SAP AMS selection"},
                {id: 2, name: "CFO", role: "Budget Owner", department: "Finance", email: "", influence: "high", interest: "medium", notes: "Controls budget envelope and commercial approval"},
                {id: 3, name: "Procurement Director", role: "Process Owner", department: "Procurement", email: "", influence: "high", interest: "high", notes: "Leads RFP process and vendor negotiations"},
                {id: 4, name: "USA Ops Lead", role: "Key User", department: "US Operations", email: "", influence: "medium", interest: "high", notes: "Critical for US Go-Live requirements"},
                {id: 5, name: "IT Ops Manager", role: "Technical Lead", department: "IT Operations", email: "", influence: "medium", interest: "high", notes: "Manages current SAP support, ticket data owner"},
                {id: 6, name: "Global Procurement", role: "Stakeholder", department: "Procurement", email: "", influence: "medium", interest: "medium", notes: "Coordinates global vendor management"},
                {id: 7, name: "Programme Lead", role: "Project Manager", department: "PMO", email: "", influence: "medium", interest: "high", notes: "Day-to-day RFP coordination"}
            ],
            raciActivities: [
                {id: 1, activity: "RFP Strategy & Planning", raci: {1: "A", 2: "C", 3: "R", 4: "I", 5: "C", 6: "C", 7: "R"}},
                {id: 2, activity: "Vendor Long List Creation", raci: {1: "I", 2: "I", 3: "A", 4: "C", 5: "C", 6: "R", 7: "R"}},
                {id: 3, activity: "Selection Questionnaire (SQ)", raci: {1: "I", 2: "I", 3: "A", 4: "C", 5: "C", 6: "C", 7: "R"}},
                {id: 4, activity: "Vendor Evaluation & Scoring", raci: {1: "A", 2: "C", 3: "R", 4: "R", 5: "R", 6: "C", 7: "R"}},
                {id: 5, activity: "Commercial Negotiation", raci: {1: "A", 2: "R", 3: "R", 4: "I", 5: "I", 6: "C", 7: "C"}},
                {id: 6, activity: "Contract Award Decision", raci: {1: "A", 2: "A", 3: "R", 4: "C", 5: "C", 6: "I", 7: "I"}},
                {id: 7, activity: "Transition Planning", raci: {1: "I", 2: "I", 3: "C", 4: "R", 5: "A", 6: "I", 7: "R"}},
                {id: 8, activity: "US Go-Live Support", raci: {1: "I", 2: "I", 3: "I", 4: "A", 5: "R", 6: "I", 7: "C"}}
            ],
            documents: [
                {id: "discovery", name: "1. Discovery & Strategy", icon: "ðŸ“‚", documents: [
                    {id: 1, name: "Project Charter.docx", status: "template", folder: "discovery"},
                    {id: 2, name: "Stakeholder Register.xlsx", status: "draft", folder: "discovery"},
                    {id: 3, name: "Deloitte Due Diligence Report.pdf", status: "final", folder: "discovery"},
                    {id: 4, name: "Gap Analysis Summary.docx", status: "draft", folder: "discovery"},
                    {id: 5, name: "USA Requirements List.xlsx", status: "template", folder: "discovery"},
                    {id: 6, name: "Market Sounding Notes.docx", status: "template", folder: "discovery"},
                    {id: 7, name: "Incumbent Strategy Notes.docx", status: "template", folder: "discovery"}
                ]},
                {id: "documentation", name: "2. RFP Documentation", icon: "ðŸ“‚", documents: [
                    {id: 8, name: "Selection Questionnaire (SQ).docx", status: "draft", folder: "documentation"},
                    {id: 9, name: "Vendor Long List.xlsx", status: "draft", folder: "documentation"},
                    {id: 10, name: "Sourcing Strategy.docx", status: "template", folder: "documentation"},
                    {id: 11, name: "Commercial Model Template.xlsx", status: "template", folder: "documentation"},
                    {id: 12, name: "Pricing Template.xlsx", status: "template", folder: "documentation"},
                    {id: 13, name: "RFP Document.docx", status: "template", folder: "documentation"},
                    {id: 14, name: "Terms & Conditions.docx", status: "template", folder: "documentation"},
                    {id: 15, name: "NDA Template.docx", status: "final", folder: "documentation"}
                ]},
                {id: "evaluation", name: "3. Evaluation & Selection", icon: "ðŸ“‚", documents: [
                    {id: 16, name: "Evaluation Criteria Matrix.xlsx", status: "template", folder: "evaluation"},
                    {id: 17, name: "Vendor Scorecard Template.xlsx", status: "template", folder: "evaluation"},
                    {id: 18, name: "Presentation Agenda Template.docx", status: "template", folder: "evaluation"},
                    {id: 19, name: "Reference Check Questions.docx", status: "template", folder: "evaluation"},
                    {id: 20, name: "Technical Assessment Checklist.xlsx", status: "template", folder: "evaluation"},
                    {id: 21, name: "Commercial Comparison Matrix.xlsx", status: "template", folder: "evaluation"}
                ]},
                {id: "selection", name: "4. Final Selection & Award", icon: "ðŸ“‚", documents: [
                    {id: 22, name: "Recommendation Report.docx", status: "template", folder: "selection"},
                    {id: 23, name: "Contract Draft.docx", status: "template", folder: "selection"},
                    {id: 24, name: "SLA Document.docx", status: "template", folder: "selection"},
                    {id: 25, name: "Transition Plan Template.docx", status: "template", folder: "selection"},
                    {id: 26, name: "Executive Approval Form.docx", status: "template", folder: "selection"},
                    {id: 27, name: "Vendor Notification Letters.docx", status: "template", folder: "selection"}
                ]},
                {id: "governance", name: "5. Programme Governance", icon: "ðŸ“‚", documents: [
                    {id: 28, name: "RACI Matrix.xlsx", status: "draft", folder: "governance"},
                    {id: 29, name: "Risk Register.xlsx", status: "draft", folder: "governance"},
                    {id: 30, name: "Weekly Status Report Template.pptx", status: "template", folder: "governance"},
                    {id: 31, name: "Steering Committee Pack.pptx", status: "template", folder: "governance"},
                    {id: 32, name: "Decision Log.xlsx", status: "template", folder: "governance"},
                    {id: 33, name: "Issues Log.xlsx", status: "template", folder: "governance"}
                ]}
            ],
            meetings: [
                {id: 1, title: "RFP Kick-off Meeting", date: "2025-12-08", time: "09:00", duration: 2, location: "Main Conference Room", attendees: "CIO, Procurement Director, Programme Lead", agenda: "Project objectives, timeline review, team introductions", type: "internal"},
                {id: 2, title: "Stakeholder Workshop - USA Requirements", date: "2025-12-10", time: "14:00", duration: 3, location: "Teams", attendees: "USA Ops Lead, IT Ops Manager, CIO", agenda: "Deep dive into US operations requirements and June vs Sept scenarios", type: "workshop"},
                {id: 3, title: "Deloitte Report Review", date: "2025-12-09", time: "10:00", duration: 1.5, location: "Teams", attendees: "Deloitte Rep, CIO, Programme Lead", agenda: "Review due diligence findings, identify gaps", type: "review"},
                {id: 4, title: "CFO Budget Discussion", date: "2025-12-11", time: "11:00", duration: 1, location: "CFO Office", attendees: "CFO, CIO, Global Procurement", agenda: "Budget envelope discussion, commercial constraints", type: "internal"},
                {id: 5, title: "Steering Committee Meeting", date: "2025-12-22", time: "15:00", duration: 1.5, location: "Boardroom", attendees: "CIO, CFO, Procurement Director, Programme Lead", agenda: "Strategy review, milestone approval, risk escalation", type: "steering"},
                {id: 6, title: "SQ Launch Briefing", date: "2026-01-05", time: "10:00", duration: 1, location: "Teams", attendees: "Procurement Director, Programme Lead", agenda: "Finalize SQ distribution, vendor communication plan", type: "internal"},
                {id: 7, title: "Steering Committee - January", date: "2026-01-15", time: "15:00", duration: 1.5, location: "Boardroom", attendees: "CIO, CFO, Procurement Director, Programme Lead", agenda: "SQ progress update, vendor response tracking", type: "steering"},
                {id: 8, title: "Shortlist Decision Workshop", date: "2026-01-30", time: "09:00", duration: 4, location: "Main Conference Room", attendees: "CIO, Procurement Director, IT Ops, USA Ops Lead", agenda: "Review SQ scores, select shortlist vendors", type: "workshop"},
                {id: 9, title: "RFP Final Review", date: "2026-02-01", time: "14:00", duration: 2, location: "Teams", attendees: "Procurement Director, Legal, Programme Lead", agenda: "Final RFP document review before issue", type: "review"},
                {id: 10, title: "Steering Committee - February", date: "2026-02-15", time: "15:00", duration: 1.5, location: "Boardroom", attendees: "CIO, CFO, Procurement Director, Programme Lead", agenda: "RFP status, vendor Q&A summary", type: "steering"},
                {id: 11, title: "Vendor Presentation: Accenture", date: "2026-03-12", time: "09:00", duration: 3, location: "Main Conference Room", attendees: "Evaluation Team, CIO", agenda: "Vendor capability presentation and Q&A", type: "vendor"},
                {id: 12, title: "Vendor Presentation: Deloitte", date: "2026-03-12", time: "14:00", duration: 3, location: "Main Conference Room", attendees: "Evaluation Team, CIO", agenda: "Vendor capability presentation and Q&A", type: "vendor"},
                {id: 13, title: "Vendor Presentation: NTT DATA", date: "2026-03-13", time: "09:00", duration: 3, location: "Main Conference Room", attendees: "Evaluation Team, CIO", agenda: "Vendor capability presentation and Q&A", type: "vendor"},
                {id: 14, title: "Vendor Presentation: Capgemini", date: "2026-03-13", time: "14:00", duration: 3, location: "Main Conference Room", attendees: "Evaluation Team, CIO", agenda: "Vendor capability presentation and Q&A", type: "vendor"},
                {id: 15, title: "Steering Committee - March", date: "2026-03-20", time: "15:00", duration: 2, location: "Boardroom", attendees: "CIO, CFO, Procurement Director, Programme Lead", agenda: "Vendor presentation debrief, preliminary scoring", type: "steering"},
                {id: 16, title: "Final Selection Board", date: "2026-04-15", time: "09:00", duration: 4, location: "Boardroom", attendees: "CIO, CFO, Procurement Director, USA Ops Lead, IT Ops", agenda: "Final vendor selection decision", type: "steering"},
                {id: 17, title: "Contract Negotiation Kick-off", date: "2026-04-20", time: "10:00", duration: 2, location: "Teams", attendees: "Procurement Director, Legal, Selected Vendor", agenda: "Begin contract negotiations", type: "vendor"},
                {id: 18, title: "Transition Planning Workshop", date: "2026-05-05", time: "09:00", duration: 4, location: "Main Conference Room", attendees: "Programme Lead, IT Ops, Selected Vendor", agenda: "Detailed transition planning", type: "workshop"},
                {id: 19, title: "Steering Committee - Monthly", date: "2026-06-15", time: "15:00", duration: 1.5, location: "Boardroom", attendees: "CIO, CFO, Procurement Director, Programme Lead", agenda: "Transition progress, knowledge transfer status", type: "steering"},
                {id: 20, title: "Go-Live Readiness Review", date: "2026-08-25", time: "09:00", duration: 3, location: "Main Conference Room", attendees: "CIO, IT Ops, Programme Lead, AMS Vendor", agenda: "Final readiness check before US Go-Live", type: "review"}
            ],
            meetingNotes: []
        };

        // State Management
        let appState = {
            startDate: new Date('2025-12-08'),
            goLiveDate: new Date('2026-09-01'),
            tasks: [],
            vendors: [],
            risks: [],
            milestones: [],
            evaluation: [],
            stakeholders: [],
            raciActivities: [],
            documents: [],
            decisions: [],
            meetings: [],
            meetingNotes: [],
            meetingCalendarMonth: new Date('2025-12-01'),
            uploadedFiles: {},
            vendorScores: {},
            currentFilter: 'all',
            currentVendorFilter: 'all',
            editingTaskId: null,
            editingVendorId: null,
            editingRiskId: null,
            calendarMonth: new Date('2025-12-01'),
            theme: 'light'
        };

        // Chart instance tracking to prevent memory leaks
        let statusChart = null;

        // Confirmation callback
        let confirmCallback = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            applyTheme();
            updateDashboard();
            renderAll();
            checkOverdue();
        });

        function loadState() {
            const saved = localStorage.getItem('hexagonRFP');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    appState = { ...appState, ...loaded };
                    appState.startDate = new Date(appState.startDate);
                    appState.goLiveDate = new Date(appState.goLiveDate);
                    appState.meetingCalendarMonth = new Date(appState.meetingCalendarMonth || '2025-12-01');
                } catch(e) {
                    console.error('Error loading state:', e);
                    initializeFromDefault();
                }
            } else {
                initializeFromDefault();
            }
        }

        function initializeFromDefault() {
            appState.tasks = JSON.parse(JSON.stringify(INITIAL_DATA.tasks));
            appState.vendors = JSON.parse(JSON.stringify(INITIAL_DATA.vendors));
            appState.risks = JSON.parse(JSON.stringify(INITIAL_DATA.risks));
            appState.milestones = JSON.parse(JSON.stringify(INITIAL_DATA.milestones));
            appState.evaluation = JSON.parse(JSON.stringify(INITIAL_DATA.evaluation));
            appState.stakeholders = JSON.parse(JSON.stringify(INITIAL_DATA.stakeholders));
            appState.raciActivities = JSON.parse(JSON.stringify(INITIAL_DATA.raciActivities));
            appState.documents = JSON.parse(JSON.stringify(INITIAL_DATA.documents));
            appState.decisions = JSON.parse(JSON.stringify(INITIAL_DATA.decisions || []));
            appState.meetings = JSON.parse(JSON.stringify(INITIAL_DATA.meetings || []));
            appState.meetingNotes = JSON.parse(JSON.stringify(INITIAL_DATA.meetingNotes || []));
            appState.vendorScores = JSON.parse(JSON.stringify(INITIAL_DATA.vendorScores || {}));
            saveState();
        }

        // Sanitize HTML to prevent XSS
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ==========================================
        // VERCEL BLOB STORAGE FUNCTIONS
        // ==========================================

        // Check if we're running on Vercel (has API routes) or locally
        function isVercelEnvironment() {
            return window.location.hostname !== 'localhost' &&
                   window.location.hostname !== '127.0.0.1' &&
                   !window.location.hostname.includes('file://');
        }

        // Upload file to Vercel Blob storage
        async function uploadToVercelBlob(file, folder, documentType = 'document') {
            // For local development, fall back to base64 storage
            if (!isVercelEnvironment()) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({
                        url: e.target.result,
                        isBase64: true,
                        filename: file.name
                    });
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsDataURL(file);
                });
            }

            try {
                console.log('Starting upload to /api/upload', {
                    filename: file.name,
                    folder: folder,
                    documentType: documentType,
                    fileSize: file.size,
                    fileType: file.type
                });

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'X-Filename': encodeURIComponent(file.name),
                        'X-Folder': encodeURIComponent(folder),
                        'X-Document-Type': encodeURIComponent(documentType),
                    },
                    body: file,
                });

                console.log('Upload response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                if (!response.ok) {
                    let errorMessage = 'Upload failed';
                    let errorDetails = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || 'Upload failed';
                        errorDetails = JSON.stringify(errorData);
                    } catch (parseError) {
                        // Response wasn't JSON - might be HTML error page
                        const text = await response.text();
                        errorMessage = `Server returned ${response.status}: ${response.statusText}`;
                        errorDetails = text.substring(0, 200);
                        console.error('Non-JSON error response:', text);
                    }
                    console.error('Upload failed:', { status: response.status, errorMessage, errorDetails });
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('Upload successful:', result);
                return {
                    url: result.url,
                    pathname: result.pathname,
                    filename: result.filename,
                    size: result.size,
                    uploadedAt: result.uploadedAt,
                    isBase64: false
                };
            } catch (error) {
                console.error('Vercel Blob upload error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                throw error;
            }
        }

        // Delete file from Vercel Blob storage
        async function deleteFromVercelBlob(url) {
            // Skip deletion for base64 data URLs
            if (!url || url.startsWith('data:')) {
                return true;
            }

            if (!isVercelEnvironment()) {
                return true;
            }

            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Delete error:', error);
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Vercel Blob delete error:', error);
                return false;
            }
        }

        // Download file from URL or base64
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            // For Vercel Blob URLs, we need to handle cross-origin
            if (!url.startsWith('data:')) {
                link.target = '_blank';
            }
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // Theme toggle
        function toggleTheme() {
            appState.theme = appState.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', appState.theme);
            document.getElementById('themeIcon').textContent = appState.theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            saveState();
        }

        // Apply saved theme on load
        function applyTheme() {
            if (appState.theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }
        }

        // Confirmation dialog
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmButton').onclick = () => {
                closeModal('confirmModal');
                if (confirmCallback) confirmCallback();
            };
            document.getElementById('confirmModal').style.display = 'block';
        }

        function saveState(showNotification = false) {
            localStorage.setItem('hexagonRFP', JSON.stringify(appState));
            if (showNotification) {
                showToast('Changes saved', 'success');
            }
        }

        function resetAppData() {
            if (confirm('Reset all data to defaults? This will load the latest tasks, meetings, and features. Your current changes will be lost.')) {
                localStorage.removeItem('hexagonRFP');
                showToast('Reloading with fresh data...', 'success');
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        function updateDashboard() {
            // Days counter
            const today = new Date();
            const daysSince = Math.floor((today - appState.startDate) / (1000*60*60*24)) + 1;
            document.getElementById('daysCounter').textContent = `Day ${daysSince}`;

            // Days to go-live
            const daysTo = Math.floor((appState.goLiveDate - today) / (1000*60*60*24));
            document.getElementById('daysToGoLive').textContent = daysTo;

            // Task progress
            const complete = appState.tasks.filter(t => t.status === 'done').length;
            const progress = appState.tasks.length > 0 ? Math.round((complete / appState.tasks.length) * 100) : 0;
            document.getElementById('taskProgress').textContent = `${progress}%`;

            // Vendor and risk counts
            document.getElementById('vendorCount').textContent = appState.vendors.length;
            document.getElementById('riskCount').textContent = appState.risks.length;

            // Render charts and lists
            renderStatusChart();
            renderUpcomingTasks();
            renderRedRisks();
        }

        function renderStatusChart() {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;

            // Destroy existing chart to prevent memory leak
            if (statusChart) {
                statusChart.destroy();
                statusChart = null;
            }

            const counts = {
                'Not Started': appState.tasks.filter(t => t.status === 'notstarted').length,
                'In Progress': appState.tasks.filter(t => t.status === 'inprogress').length,
                'Done': appState.tasks.filter(t => t.status === 'done').length
            };

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: ['rgba(206,212,218,0.7)', 'rgba(0,102,204,0.7)', 'rgba(40,167,69,0.7)'],
                        borderColor: ['rgba(206,212,218,1)', 'rgba(0,102,204,1)', 'rgba(40,167,69,1)'],
                        borderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderUpcomingTasks() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);

            const upcoming = appState.tasks.filter(t => {
                const due = new Date(t.dueDate);
                return due >= today && due <= nextWeek && t.status !== 'done';
            }).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));

            const html = upcoming.length ? upcoming.map(t => `
                <div style="padding: 10px; border-left: 3px solid var(--primary); margin-bottom: 10px; background: var(--gray-50); border-radius: 4px;">
                    <div style="font-weight: 600;">${t.name}</div>
                    <div style="font-size: 0.85em; color: var(--gray-700); margin-top: 5px;">
                        Due: ${formatDate(t.dueDate)} | ${t.owner}
                    </div>
                </div>
            `).join('') : '<p style="color: var(--gray-700);">No tasks due in next 7 days</p>';

            const el = document.getElementById('upcomingTasks');
            if (el) el.innerHTML = html;
        }

        function renderRedRisks() {
            const red = appState.risks.filter(r => r.rag === 'red');
            const html = red.length ? red.map(r => `
                <div style="padding: 10px; border-left: 3px solid var(--danger); margin-bottom: 10px; background: #fff5f5; border-radius: 4px;">
                    <div style="font-weight: 600;">${r.risk}</div>
                    <div style="font-size: 0.85em; color: var(--gray-700); margin-top: 5px;">
                        ${r.mitigation}
                    </div>
                </div>
            `).join('') : '<p style="color: var(--gray-700);">No red risks</p>';

            const el = document.getElementById('redRisks');
            if (el) el.innerHTML = html;
        }

        function renderAll() {
            renderTaskList();
            renderMilestones();
            renderEvaluationTable();
            renderVendorGrid();
            renderRiskList();
            renderRiskMatrix();
            renderDecisionList();
            renderStakeholders();
            renderRaciMatrix();
            renderCalendar();
            renderGantt();
            renderDocuments();
            renderScoringTable();
            renderMeetingCalendar();
            renderMeetingsList();
            renderMeetingNotesList();
        }

        // Check for overdue tasks
        function checkOverdue() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const overdue = appState.tasks.filter(t => {
                if (t.status === 'done') return false;
                const due = new Date(t.dueDate);
                return due < today;
            });

            const warning = document.getElementById('overdueWarning');
            const list = document.getElementById('overdueList');

            if (overdue.length > 0 && warning && list) {
                warning.style.display = 'block';
                list.innerHTML = overdue.map(t =>
                    `<div style="padding: 5px 0; border-bottom: 1px solid #ffcccc;">
                        <strong>${sanitizeHTML(t.name)}</strong> - Due: ${formatDate(t.dueDate)}
                    </div>`
                ).join('');
            } else if (warning) {
                warning.style.display = 'none';
            }
        }

        function renderTaskList() {
            let tasks = appState.tasks;
            
            // Apply filter
            if (appState.currentFilter !== 'all') {
                tasks = tasks.filter(t => t.status === appState.currentFilter);
            }

            // Apply search
            const searchEl = document.getElementById('taskSearch');
            if (searchEl) {
                const search = searchEl.value.toLowerCase();
                if (search) {
                    tasks = tasks.filter(t => 
                        t.name.toLowerCase().includes(search) || 
                        (t.description && t.description.toLowerCase().includes(search))
                    );
                }
            }

            // Group by phase
            const phases = {
                discovery: { title: 'Phase 1: Discovery & Strategy', tasks: [] },
                documentation: { title: 'Phase 2: RFP Documentation', tasks: [] },
                evaluation: { title: 'Phase 3: Evaluation & Selection', tasks: [] },
                selection: { title: 'Phase 4: Final Selection & Award', tasks: [] }
            };

            tasks.forEach(t => { 
                if(phases[t.phase]) {
                    phases[t.phase].tasks.push(t); 
                }
            });

            const html = Object.entries(phases).map(([key, phase]) => {
                if (!phase.tasks.length) return '';
                
                const done = phase.tasks.filter(t => t.status === 'done').length;
                const pct = Math.round((done / phase.tasks.length) * 100);

                return `
                    <div style="margin-bottom: 30px;">
                        <div class="phase-header">
                            <div>${phase.title}</div>
                            <div>${done}/${phase.tasks.length} complete (${pct}%)</div>
                        </div>
                        ${phase.tasks.map(t => `
                            <div class="task-item ${t.status === 'done' ? 'completed' : ''}">
                                <input type="checkbox" class="task-checkbox" 
                                    ${t.status === 'done' ? 'checked' : ''} 
                                    onchange="toggleTask(${t.id})">
                                <div>
                                    <div class="task-title">${t.name}</div>
                                    <div class="task-meta">${t.owner} | ${t.description || ''}</div>
                                </div>
                                <div style="font-size: 0.9em; color: var(--gray-700);">${formatDate(t.dueDate)}</div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-small btn-primary" onclick="editTask(${t.id})">âœï¸</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteTask(${t.id})">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');

            const el = document.getElementById('taskList');
            if (el) el.innerHTML = html || '<p>No tasks found</p>';
        }

        function renderMilestones() {
            const done = appState.milestones.filter(m => m.status === 'done').length;
            const pct = Math.round((done / appState.milestones.length) * 100);
            
            const progressEl = document.getElementById('milestoneProgress');
            if (progressEl) {
                progressEl.textContent = `${pct}%`;
                progressEl.style.width = `${pct}%`;
            }

            const html = appState.milestones.map((m, i) => `
                <div class="milestone-item">
                    <div class="milestone-dot" style="${m.status === 'done' ? 'background: var(--success);' : ''}">${i+1}</div>
                    <div class="milestone-content">
                        <div class="milestone-title">${m.title}</div>
                        <div style="color: var(--gray-700); font-size: 0.9em; margin: 5px 0;">Target: ${formatDate(m.date)}</div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-small ${m.status === 'done' ? 'btn-success' : 'btn-primary'}" 
                                onclick="toggleMilestone(${m.id})">
                                ${m.status === 'done' ? 'âœ“ Complete' : 'Mark Complete'}
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteMilestone(${m.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            const el = document.getElementById('milestoneList');
            if (el) el.innerHTML = html;
        }

        function renderEvaluationTable() {
            const html = appState.evaluation.map(c => `
                <tr>
                    <td><div class="editable" contenteditable="true" data-id="${c.id}" data-field="criterion">${c.criterion}</div></td>
                    <td><input type="number" class="weight-input" value="${c.weight}" data-id="${c.id}" onchange="updateWeight(${c.id}, this.value)"></td>
                    <td><div class="editable" contenteditable="true" data-id="${c.id}" data-field="goodLooks">${c.goodLooks}</div></td>
                    <td><div class="editable" contenteditable="true" data-id="${c.id}" data-field="redFlags">${c.redFlags}</div></td>
                    <td><button class="btn btn-small btn-danger" onclick="deleteCriterion(${c.id})">ðŸ—‘ï¸</button></td>
                </tr>
            `).join('');

            const el = document.getElementById('criteriaBody');
            if (el) el.innerHTML = html;

            // Add blur event listeners
            document.querySelectorAll('.editable').forEach(el => {
                el.addEventListener('blur', function() {
                    const id = parseInt(this.dataset.id);
                    const field = this.dataset.field;
                    const value = this.textContent;
                    updateCriterion(id, field, value);
                });
            });

            // Update total weight
            const total = appState.evaluation.reduce((sum, c) => sum + c.weight, 0);
            const totalEl = document.getElementById('totalWeight');
            if (totalEl) totalEl.textContent = total;
        }

        function renderVendorGrid() {
            let vendors = appState.vendors;
            const f = appState.currentVendorFilter;

            // Apply filter
            if (f === 'tier1') {
                vendors = vendors.filter(v => v.tier === 'Tier 1');
            } else if (f === 'tier2') {
                vendors = vendors.filter(v => v.tier.includes('Tier 2') || v.tier === 'Mid' || v.tier === 'Niche');
            } else if (f === 'warm') {
                vendors = vendors.filter(v => v.status === 'warm');
            } else if (f === 'shortlist') {
                vendors = vendors.filter(v => v.status === 'shortlist');
            }

            // Apply search
            const searchEl = document.getElementById('vendorSearch');
            if (searchEl) {
                const search = searchEl.value.toLowerCase();
                if (search) {
                    vendors = vendors.filter(v =>
                        v.name.toLowerCase().includes(search) ||
                        (v.strengths && v.strengths.toLowerCase().includes(search)) ||
                        (v.relevance && v.relevance.toLowerCase().includes(search))
                    );
                }
            }

            const html = vendors.map(v => `
                <div class="vendor-card">
                    <div class="vendor-name">${v.name}</div>
                    <span class="vendor-status status-${v.status}">
                        ${v.status === 'warm' ? 'ðŸŸ¢ Warm' : 
                          v.status === 'shortlist' ? 'â­ Shortlist' : 
                          v.status === 'finalist' ? 'ðŸŽ¯ Finalist' :
                          v.status === 'winner' ? 'ðŸ† Winner' : 'âšª Long List'}
                    </span>
                    <div style="margin: 10px 0; font-size: 0.9em; color: var(--gray-700);">
                        <strong>${v.tier}</strong> | ${v.type}
                    </div>
                    <div style="font-size: 0.9em; margin: 10px 0; line-height: 1.5;">${v.strengths}</div>
                    <div style="font-size: 0.9em; color: var(--gray-700); margin: 10px 0; padding-top: 10px; border-top: 1px solid var(--gray-200);">
                        <strong>Hexagon Fit:</strong> ${v.relevance}
                    </div>
                    <select class="form-select" style="margin-top: 10px;" onchange="updateVendorStatus(${v.id}, this.value)">
                        <option value="longlist" ${v.status === 'longlist' ? 'selected' : ''}>Long List</option>
                        <option value="warm" ${v.status === 'warm' ? 'selected' : ''}>Warm Lead</option>
                        <option value="shortlist" ${v.status === 'shortlist' ? 'selected' : ''}>Shortlist</option>
                        <option value="finalist" ${v.status === 'finalist' ? 'selected' : ''}>Finalist</option>
                        <option value="winner" ${v.status === 'winner' ? 'selected' : ''}>Winner</option>
                        <option value="rejected" ${v.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                    <button class="btn btn-small btn-danger" style="width: 100%; margin-top: 10px;" onclick="deleteVendor(${v.id})">Delete</button>
                </div>
            `).join('');

            const el = document.getElementById('vendorGrid');
            if (el) el.innerHTML = html;
        }

        function renderRiskList() {
            const html = appState.risks.map(r => `
                <div class="risk-card risk-${r.rag}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                        <strong style="font-size: 1.1em;">${r.risk}</strong>
                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;
                            background: ${r.rag === 'red' ? '#ffe5e5' : r.rag === 'amber' ? '#fff9e5' : '#e5f9e5'};
                            color: ${r.rag === 'red' ? '#dc3545' : r.rag === 'amber' ? '#996600' : '#28a745'};">
                            ${r.rag === 'red' ? 'ðŸ”´ RED' : r.rag === 'amber' ? 'ðŸŸ¡ AMBER' : 'ðŸŸ¢ GREEN'}
                        </span>
                    </div>
                    <p style="margin: 8px 0;"><strong>Impact:</strong> ${r.impact}</p>
                    <p style="margin: 8px 0;"><strong>Owner:</strong> ${r.owner} | <strong>Due:</strong> ${formatDate(r.dueDate)}</p>
                    <p style="margin: 8px 0;"><strong>Mitigation:</strong> ${r.mitigation}</p>
                    <button class="btn btn-small btn-danger" style="margin-top: 10px;" onclick="deleteRisk(${r.id})">Delete Risk</button>
                </div>
            `).join('');

            const el = document.getElementById('riskList');
            if (el) el.innerHTML = html;
        }

        // Utility Functions
        function formatDate(d) {
            if (!d) return 'No date';
            const date = new Date(d);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function switchTab(tab, e) {
            document.querySelectorAll('.tab-content').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-hidden', 'true');
            });
            document.querySelectorAll('.nav-tab').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });

            const tabEl = document.getElementById(tab);
            if (tabEl) {
                tabEl.classList.add('active');
                tabEl.setAttribute('aria-hidden', 'false');
            }

            const tabBtn = document.getElementById('tab-' + tab);
            if (tabBtn) {
                tabBtn.classList.add('active');
                tabBtn.setAttribute('aria-selected', 'true');
            } else if (e && e.target) {
                e.target.classList.add('active');
                e.target.setAttribute('aria-selected', 'true');
            }

            if (tab === 'dashboard') updateDashboard();
            if (tab === 'scoring') renderScoringTable();
        }

        function filterTasks(f, e) {
            appState.currentFilter = f;
            renderTaskList();
            document.querySelectorAll('#workplan .filter-bar .filter-btn').forEach(b => b.classList.remove('active'));
            if (e && e.target) e.target.classList.add('active');
        }

        function filterVendors(f, e) {
            appState.currentVendorFilter = f;
            renderVendorGrid();
            document.querySelectorAll('#vendors .filter-bar .filter-btn').forEach(b => b.classList.remove('active'));
            if (e && e.target) e.target.classList.add('active');
        }

        // Task Management
        function addTask() {
            appState.editingTaskId = null;
            document.getElementById('taskModalTitle').textContent = 'Add New Task';
            document.getElementById('taskName').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskOwner').value = '';
            document.getElementById('taskDueDate').value = '';
            document.getElementById('taskStatus').value = 'notstarted';
            document.getElementById('taskPhase').value = 'discovery';
            document.getElementById('taskModal').style.display = 'block';
        }

        function editTask(id) {
            const task = appState.tasks.find(t => t.id === id);
            if (!task) return;
            
            appState.editingTaskId = id;
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskOwner').value = task.owner;
            document.getElementById('taskDueDate').value = task.dueDate;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskPhase').value = task.phase;
            document.getElementById('taskModal').style.display = 'block';
        }

        function saveTask() {
            const data = {
                name: document.getElementById('taskName').value,
                description: document.getElementById('taskDescription').value,
                owner: document.getElementById('taskOwner').value,
                dueDate: document.getElementById('taskDueDate').value,
                status: document.getElementById('taskStatus').value,
                phase: document.getElementById('taskPhase').value
            };

            if (!data.name) { 
                alert('Please enter task name'); 
                return; 
            }

            if (appState.editingTaskId) {
                const i = appState.tasks.findIndex(t => t.id === appState.editingTaskId);
                if (i !== -1) {
                    appState.tasks[i] = { ...appState.tasks[i], ...data };
                }
            } else {
                const newId = Math.max(...appState.tasks.map(t => t.id), 0) + 1;
                appState.tasks.push({ id: newId, ...data });
            }

            saveState();
            renderAll();
            updateDashboard();
            closeModal('taskModal');
        }

        function toggleTask(id) {
            const task = appState.tasks.find(t => t.id === id);
            if (task) {
                const wasCompleted = task.status === 'done';
                task.status = wasCompleted ? 'notstarted' : 'done';
                saveState();
                renderAll();
                updateDashboard();
                showToast(wasCompleted ? 'Task reopened' : 'Task completed & saved!', 'success');
            }
        }

        function deleteTask(id) {
            if (confirm('Delete this task?')) {
                appState.tasks = appState.tasks.filter(t => t.id !== id);
                saveState();
                renderAll();
                updateDashboard();
            }
        }

        // Milestone Management
        function addMilestone() {
            const title = prompt('Milestone title:');
            if (!title) return;
            
            const date = prompt('Target date (YYYY-MM-DD):');
            if (!date) return;

            const newId = Math.max(...appState.milestones.map(m => m.id), 0) + 1;
            appState.milestones.push({
                id: newId,
                title: title,
                date: date,
                status: 'notstarted'
            });

            saveState();
            renderMilestones();
        }

        function toggleMilestone(id) {
            const m = appState.milestones.find(x => x.id === id);
            if (m) {
                m.status = m.status === 'done' ? 'notstarted' : 'done';
                saveState();
                renderMilestones();
            }
        }

        function deleteMilestone(id) {
            if (confirm('Delete this milestone?')) {
                appState.milestones = appState.milestones.filter(m => m.id !== id);
                saveState();
                renderMilestones();
            }
        }

        // Evaluation Management
        function addCriterion() {
            const newId = Math.max(...appState.evaluation.map(c => c.id), 0) + 1;
            appState.evaluation.push({
                id: newId,
                criterion: 'New Criterion',
                weight: 0,
                goodLooks: 'Define what good looks like',
                redFlags: 'Define red flags'
            });
            renderEvaluationTable();
        }

        function updateCriterion(id, field, value) {
            const c = appState.evaluation.find(x => x.id === id);
            if (c) {
                c[field] = value;
                saveState();
            }
        }

        function updateWeight(id, value) {
            const c = appState.evaluation.find(x => x.id === id);
            if (c) {
                c.weight = parseInt(value) || 0;
                saveState();
                renderEvaluationTable();
            }
        }

        function deleteCriterion(id) {
            if (confirm('Delete this criterion?')) {
                appState.evaluation = appState.evaluation.filter(c => c.id !== id);
                saveState();
                renderEvaluationTable();
            }
        }

        function saveEvaluation() {
            saveState();
            alert('âœ“ Evaluation framework saved successfully!');
        }

        // Vendor Management
        function openVendorModal(id = null) {
            appState.editingVendorId = id;
            if (id) {
                const v = appState.vendors.find(x => x.id === id);
                if (v) {
                    document.getElementById('vendorModalTitle').textContent = 'Edit Vendor';
                    document.getElementById('vendorName').value = v.name;
                    document.getElementById('vendorType').value = v.type || '';
                    document.getElementById('vendorTier').value = v.tier || 'Tier 2';
                    document.getElementById('vendorStrengths').value = v.strengths || '';
                    document.getElementById('vendorRelevance').value = v.relevance || '';
                }
            } else {
                document.getElementById('vendorModalTitle').textContent = 'Add New Vendor';
                document.getElementById('vendorName').value = '';
                document.getElementById('vendorType').value = '';
                document.getElementById('vendorTier').value = 'Tier 2';
                document.getElementById('vendorStrengths').value = '';
                document.getElementById('vendorRelevance').value = '';
            }
            document.getElementById('vendorModal').style.display = 'block';
        }

        function saveVendor() {
            const name = document.getElementById('vendorName').value.trim();
            if (!name) {
                showToast('Please enter vendor name', 'error');
                return;
            }

            const data = {
                name: sanitizeHTML(name),
                type: sanitizeHTML(document.getElementById('vendorType').value.trim()) || 'SI',
                tier: document.getElementById('vendorTier').value,
                strengths: sanitizeHTML(document.getElementById('vendorStrengths').value.trim()),
                relevance: sanitizeHTML(document.getElementById('vendorRelevance').value.trim()),
                status: 'longlist'
            };

            if (appState.editingVendorId) {
                const i = appState.vendors.findIndex(v => v.id === appState.editingVendorId);
                if (i !== -1) {
                    appState.vendors[i] = { ...appState.vendors[i], ...data };
                }
            } else {
                const newId = Math.max(...appState.vendors.map(v => v.id), 0) + 1;
                appState.vendors.push({ id: newId, ...data });
            }

            saveState();
            renderVendorGrid();
            updateDashboard();
            closeModal('vendorModal');
            showToast('Vendor saved successfully', 'success');
        }

        function updateVendorStatus(id, status) {
            const v = appState.vendors.find(x => x.id === id);
            if (v) {
                v.status = status;
                saveState();
                renderVendorGrid();
            }
        }

        function deleteVendor(id) {
            showConfirm('Delete this vendor?', () => {
                appState.vendors = appState.vendors.filter(v => v.id !== id);
                saveState();
                renderVendorGrid();
                updateDashboard();
                showToast('Vendor deleted', 'success');
            });
        }

        // Risk Management
        function openRiskModal(id = null) {
            appState.editingRiskId = id;
            if (id) {
                const r = appState.risks.find(x => x.id === id);
                if (r) {
                    document.getElementById('riskModalTitle').textContent = 'Edit Risk';
                    document.getElementById('riskName').value = r.risk;
                    document.getElementById('riskImpact').value = r.impact || '';
                    document.getElementById('riskOwner').value = r.owner || '';
                    document.getElementById('riskDueDate').value = r.dueDate || '';
                    document.getElementById('riskRag').value = r.rag || 'amber';
                    document.getElementById('riskProbability').value = r.probability || 'medium';
                    document.getElementById('riskImpactLevel').value = r.impactLevel || 'medium';
                    document.getElementById('riskMitigation').value = r.mitigation || '';
                }
            } else {
                document.getElementById('riskModalTitle').textContent = 'Add New Risk';
                document.getElementById('riskName').value = '';
                document.getElementById('riskImpact').value = '';
                document.getElementById('riskOwner').value = '';
                document.getElementById('riskDueDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('riskRag').value = 'amber';
                document.getElementById('riskProbability').value = 'medium';
                document.getElementById('riskImpactLevel').value = 'medium';
                document.getElementById('riskMitigation').value = '';
            }
            document.getElementById('riskModal').style.display = 'block';
        }

        function saveRisk() {
            const risk = document.getElementById('riskName').value.trim();
            if (!risk) {
                showToast('Please enter risk description', 'error');
                return;
            }

            const data = {
                risk: sanitizeHTML(risk),
                impact: sanitizeHTML(document.getElementById('riskImpact').value.trim()),
                owner: sanitizeHTML(document.getElementById('riskOwner').value.trim()),
                dueDate: document.getElementById('riskDueDate').value,
                rag: document.getElementById('riskRag').value,
                probability: document.getElementById('riskProbability').value,
                impactLevel: document.getElementById('riskImpactLevel').value,
                mitigation: sanitizeHTML(document.getElementById('riskMitigation').value.trim())
            };

            if (appState.editingRiskId) {
                const i = appState.risks.findIndex(r => r.id === appState.editingRiskId);
                if (i !== -1) {
                    appState.risks[i] = { ...appState.risks[i], ...data };
                }
            } else {
                const newId = Math.max(...appState.risks.map(r => r.id), 0) + 1;
                appState.risks.push({ id: newId, ...data });
            }

            saveState();
            renderRiskList();
            renderRiskMatrix();
            updateDashboard();
            closeModal('riskModal');
            showToast('Risk saved successfully', 'success');
        }

        function deleteRisk(id) {
            showConfirm('Delete this risk?', () => {
                appState.risks = appState.risks.filter(r => r.id !== id);
                saveState();
                renderRiskList();
                renderRiskMatrix();
                updateDashboard();
                showToast('Risk deleted', 'success');
            });
        }

        // Risk Matrix
        function renderRiskMatrix() {
            const cells = {
                'high-high': [], 'high-medium': [], 'high-low': [],
                'medium-high': [], 'medium-medium': [], 'medium-low': [],
                'low-high': [], 'low-medium': [], 'low-low': []
            };

            appState.risks.forEach(r => {
                const prob = r.probability || 'medium';
                const imp = r.impactLevel || 'medium';
                const key = `${prob}-${imp}`;
                if (cells[key]) cells[key].push(r.risk);
            });

            Object.entries(cells).forEach(([key, risks]) => {
                const el = document.getElementById(`matrix-${key.replace('-', '-')}`);
                if (el) {
                    el.innerHTML = risks.length > 0
                        ? risks.map(r => `<div style="font-size:0.8em; margin:2px 0;">${sanitizeHTML(r.substring(0, 20))}${r.length > 20 ? '...' : ''}</div>`).join('')
                        : '';
                }
            });
        }

        // Reports
        function generateStatusReport() {
            const done = appState.tasks.filter(t => t.status === 'done').length;
            const pct = Math.round((done / appState.tasks.length) * 100);

            const html = `
                <h2>Weekly Status Report</h2>
                <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })}</p>
                
                <h3 style="margin-top: 20px;">Executive Summary</h3>
                <ul style="line-height: 2;">
                    <li>Overall Progress: ${pct}% (${done}/${appState.tasks.length} tasks complete)</li>
                    <li>Vendors Tracking: ${appState.vendors.length}</li>
                    <li>Active Risks: ${appState.risks.length} (${appState.risks.filter(r => r.rag === 'red').length} red)</li>
                </ul>

                <h3 style="margin-top: 20px;">Recent Accomplishments</h3>
                <ul style="line-height: 2;">
                    ${appState.tasks.filter(t => t.status === 'done').slice(0,5).map(t => `<li>${t.name}</li>`).join('') || '<li>No completed tasks yet</li>'}
                </ul>

                <h3 style="margin-top: 20px;">Next Priorities</h3>
                <ul style="line-height: 2;">
                    ${appState.tasks.filter(t => t.status !== 'done').slice(0,5).map(t => `<li>${t.name} (Due: ${formatDate(t.dueDate)})</li>`).join('')}
                </ul>

                <h3 style="margin-top: 20px;">Red Risks Requiring Attention</h3>
                <ul style="line-height: 2;">
                    ${appState.risks.filter(r => r.rag === 'red').map(r => `<li><strong>${r.risk}</strong> - ${r.mitigation}</li>`).join('') || '<li>No red risks</li>'}
                </ul>
            `;

            document.getElementById('reportOutput').innerHTML = html;
        }

        function generateVendorReport() {
            const html = `
                <h2>Vendor Pipeline Analysis</h2>
                <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })}</p>
                
                <h3 style="margin-top: 20px;">Vendor Status Summary</h3>
                <ul style="line-height: 2;">
                    <li>Long List: ${appState.vendors.filter(v => v.status === 'longlist').length}</li>
                    <li>Warm Leads: ${appState.vendors.filter(v => v.status === 'warm').length}</li>
                    <li>Shortlist: ${appState.vendors.filter(v => v.status === 'shortlist').length}</li>
                    <li>Finalists: ${appState.vendors.filter(v => v.status === 'finalist').length}</li>
                    <li>Winner: ${appState.vendors.filter(v => v.status === 'winner').length}</li>
                </ul>

                <h3 style="margin-top: 20px;">Tier Breakdown</h3>
                <ul style="line-height: 2;">
                    <li>Tier 1 (Big 4 + IBM): ${appState.vendors.filter(v => v.tier === 'Tier 1').length}</li>
                    <li>Tier 2 & Mid-tier: ${appState.vendors.filter(v => v.tier.includes('Tier 2') || v.tier === 'Mid').length}</li>
                    <li>Niche Specialists: ${appState.vendors.filter(v => v.tier === 'Niche').length}</li>
                </ul>

                <h3 style="margin-top: 20px;">Warm Leads for Priority Engagement</h3>
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>Vendor</th>
                            <th>Tier</th>
                            <th>Key Strengths</th>
                            <th>Hexagon Relevance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.vendors.filter(v => v.status === 'warm').map(v => `
                            <tr>
                                <td><strong>${v.name}</strong></td>
                                <td>${v.tier}</td>
                                <td>${v.strengths}</td>
                                <td>${v.relevance}</td>
                            </tr>
                        `).join('') || '<tr><td colspan="4">No warm leads yet</td></tr>'}
                    </tbody>
                </table>
            `;

            document.getElementById('reportOutput').innerHTML = html;
        }

        function generateRiskReport() {
            const html = `
                <h2>Risk & Dependency Report</h2>
                <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })}</p>
                
                <h3 style="margin-top: 20px;">Risk Summary</h3>
                <ul style="line-height: 2;">
                    <li>ðŸ”´ Red Risks: ${appState.risks.filter(r => r.rag === 'red').length}</li>
                    <li>ðŸŸ¡ Amber Risks: ${appState.risks.filter(r => r.rag === 'amber').length}</li>
                    <li>ðŸŸ¢ Green Risks: ${appState.risks.filter(r => r.rag === 'green').length}</li>
                </ul>

                <h3 style="margin-top: 20px;">All Risks</h3>
                ${appState.risks.map(r => `
                    <div class="risk-card risk-${r.rag}" style="page-break-inside: avoid;">
                        <strong style="font-size: 1.1em;">${r.risk}</strong>
                        <p style="margin: 8px 0;"><strong>Impact:</strong> ${r.impact}</p>
                        <p style="margin: 8px 0;"><strong>Owner:</strong> ${r.owner} | <strong>Due:</strong> ${formatDate(r.dueDate)}</p>
                        <p style="margin: 8px 0;"><strong>Mitigation:</strong> ${r.mitigation}</p>
                    </div>
                `).join('')}
            `;

            document.getElementById('reportOutput').innerHTML = html;
        }

        function exportData() {
            const data = JSON.stringify(appState, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hexagon-rfp-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Stakeholder Management
        function renderStakeholders() {
            const html = appState.stakeholders.map(s => `
                <div class="vendor-card">
                    <div class="vendor-name">${s.name}</div>
                    <span class="vendor-status" style="background: ${s.influence === 'high' ? '#ffe5e5' : '#e3f2fd'}; color: ${s.influence === 'high' ? '#c62828' : '#1976d2'};">
                        ${s.influence === 'high' ? 'â¬†ï¸ High Influence' : 'âž¡ï¸ Medium Influence'}
                    </span>
                    <div style="margin: 10px 0; font-size: 0.9em; color: var(--gray-700);">
                        <strong>${s.role}</strong> | ${s.department}
                    </div>
                    <div style="font-size: 0.9em; margin: 10px 0; line-height: 1.5;">${s.notes}</div>
                    <div style="font-size: 0.85em; color: var(--gray-700); margin: 10px 0; padding-top: 10px; border-top: 1px solid var(--gray-200);">
                        <strong>Interest Level:</strong>
                        <span style="padding: 2px 8px; border-radius: 10px; background: ${s.interest === 'high' ? '#e8f5e9' : '#fff9e5'}; color: ${s.interest === 'high' ? '#2e7d32' : '#996600'};">
                            ${s.interest === 'high' ? 'High' : 'Medium'}
                        </span>
                    </div>
                    <button class="btn btn-small btn-danger" style="width: 100%; margin-top: 10px;" onclick="deleteStakeholder(${s.id})">Delete</button>
                </div>
            `).join('');

            const el = document.getElementById('stakeholderGrid');
            if (el) el.innerHTML = html || '<p>No stakeholders added yet</p>';
        }

        function addStakeholder() {
            const name = prompt('Stakeholder name/title:');
            if (!name) return;

            const role = prompt('Role (e.g., Executive Sponsor, Key User, Technical Lead):') || 'Stakeholder';
            const department = prompt('Department:') || '';
            const influence = confirm('Is this a HIGH influence stakeholder? (OK=High, Cancel=Medium)') ? 'high' : 'medium';
            const interest = confirm('Is this a HIGH interest stakeholder? (OK=High, Cancel=Medium)') ? 'high' : 'medium';

            const newId = Math.max(...appState.stakeholders.map(s => s.id), 0) + 1;
            appState.stakeholders.push({
                id: newId,
                name: name,
                role: role,
                department: department,
                email: '',
                influence: influence,
                interest: interest,
                notes: ''
            });

            saveState();
            renderStakeholders();
            renderRaciMatrix();
        }

        function deleteStakeholder(id) {
            if (confirm('Delete this stakeholder? This will also remove them from the RACI matrix.')) {
                appState.stakeholders = appState.stakeholders.filter(s => s.id !== id);
                // Remove from RACI activities
                appState.raciActivities.forEach(a => {
                    delete a.raci[id];
                });
                saveState();
                renderStakeholders();
                renderRaciMatrix();
            }
        }

        // RACI Matrix
        function renderRaciMatrix() {
            // Render header
            const headerHtml = `
                <th style="min-width: 200px;">Activity / Deliverable</th>
                ${appState.stakeholders.map(s => `<th style="min-width: 80px; text-align: center;">${s.name}</th>`).join('')}
                <th style="min-width: 80px;">Actions</th>
            `;
            const headerEl = document.getElementById('raciHeader');
            if (headerEl) headerEl.innerHTML = headerHtml;

            // Render body
            const bodyHtml = appState.raciActivities.map(a => `
                <tr>
                    <td>
                        <div class="editable" contenteditable="true" data-activity-id="${a.id}"
                            onblur="updateActivityName(${a.id}, this.textContent)">${a.activity}</div>
                    </td>
                    ${appState.stakeholders.map(s => `
                        <td style="text-align: center;">
                            <select class="form-select" style="width: 60px; padding: 4px; text-align: center;
                                background: ${getRaciColor(a.raci[s.id])};"
                                onchange="updateRaci(${a.id}, ${s.id}, this.value)">
                                <option value="" ${!a.raci[s.id] ? 'selected' : ''}>-</option>
                                <option value="R" ${a.raci[s.id] === 'R' ? 'selected' : ''}>R</option>
                                <option value="A" ${a.raci[s.id] === 'A' ? 'selected' : ''}>A</option>
                                <option value="C" ${a.raci[s.id] === 'C' ? 'selected' : ''}>C</option>
                                <option value="I" ${a.raci[s.id] === 'I' ? 'selected' : ''}>I</option>
                            </select>
                        </td>
                    `).join('')}
                    <td style="text-align: center;">
                        <button class="btn btn-small btn-danger" onclick="deleteRaciActivity(${a.id})">ðŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');

            const bodyEl = document.getElementById('raciBody');
            if (bodyEl) bodyEl.innerHTML = bodyHtml || '<tr><td colspan="100%">No activities defined</td></tr>';
        }

        function getRaciColor(value) {
            switch(value) {
                case 'R': return '#e3f2fd';
                case 'A': return '#fff9e5';
                case 'C': return '#e8f5e9';
                case 'I': return '#fce4ec';
                default: return 'white';
            }
        }

        function updateRaci(activityId, stakeholderId, value) {
            const activity = appState.raciActivities.find(a => a.id === activityId);
            if (activity) {
                if (value) {
                    activity.raci[stakeholderId] = value;
                } else {
                    delete activity.raci[stakeholderId];
                }
                saveState();
                renderRaciMatrix();
            }
        }

        function updateActivityName(activityId, name) {
            const activity = appState.raciActivities.find(a => a.id === activityId);
            if (activity && name.trim()) {
                activity.activity = name.trim();
                saveState();
            }
        }

        function addRaciActivity() {
            const activity = prompt('Activity/Deliverable name:');
            if (!activity) return;

            const newId = Math.max(...appState.raciActivities.map(a => a.id), 0) + 1;
            appState.raciActivities.push({
                id: newId,
                activity: activity,
                raci: {}
            });

            saveState();
            renderRaciMatrix();
        }

        function deleteRaciActivity(id) {
            if (confirm('Delete this activity from the RACI matrix?')) {
                appState.raciActivities = appState.raciActivities.filter(a => a.id !== id);
                saveState();
                renderRaciMatrix();
            }
        }

        function saveRaci() {
            saveState();
            alert('âœ“ RACI matrix saved successfully!');
        }

        // Calendar Functions
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            if (!grid || !title) return;

            const month = appState.calendarMonth;
            const year = month.getFullYear();
            const monthNum = month.getMonth();

            title.textContent = month.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, monthNum, 1);
            const lastDay = new Date(year, monthNum + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = `
                <div class="calendar-header">Sun</div>
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
            `;

            // Empty cells before first day
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(monthNum + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const tasksOnDay = appState.tasks.filter(t => t.dueDate === dateStr);
                const milestonesOnDay = appState.milestones.filter(m => m.date === dateStr);
                const meetingsOnDay = appState.meetings.filter(m => m.date === dateStr);

                const today = new Date();
                const isToday = day === today.getDate() && monthNum === today.getMonth() && year === today.getFullYear();

                html += `<div class="calendar-day${isToday ? ' today' : ''}">
                    <div class="calendar-date">${day}</div>`;

                tasksOnDay.forEach(t => {
                    html += `<div class="calendar-event task" title="${t.name}">${t.name.substring(0, 15)}${t.name.length > 15 ? '...' : ''}</div>`;
                });

                meetingsOnDay.forEach(m => {
                    html += `<div class="calendar-event meeting" title="${m.title}" style="background: #e8f5e9; color: #2e7d32; font-size: 10px; padding: 2px 4px; margin: 1px 0; border-radius: 3px; cursor: pointer;">ðŸ“… ${m.title.substring(0, 12)}${m.title.length > 12 ? '...' : ''}</div>`;
                });

                milestonesOnDay.forEach(m => {
                    const mTitle = m.title || m.name;
                    html += `<div class="calendar-event milestone" title="${mTitle}">ðŸŽ¯ ${mTitle.substring(0, 12)}${mTitle.length > 12 ? '...' : ''}</div>`;
                });

                html += '</div>';
            }

            grid.innerHTML = html;
        }

        function changeMonth(delta) {
            const current = appState.calendarMonth;
            appState.calendarMonth = new Date(current.getFullYear(), current.getMonth() + delta, 1);
            renderCalendar();
        }

        // Gantt Chart Functions
        function renderGantt() {
            const container = document.getElementById('ganttChart');
            if (!container) return;

            const tasks = appState.tasks;
            const milestones = appState.milestones;

            if (tasks.length === 0 && milestones.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">No tasks or milestones to display. Add tasks and milestones with dates to see the Gantt chart.</div>';
                return;
            }

            // Find date range
            const allDates = [
                ...tasks.filter(t => t.dueDate).map(t => new Date(t.dueDate)),
                ...milestones.filter(m => m.date).map(m => new Date(m.date))
            ];

            if (allDates.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">Add due dates to tasks and milestones to see the Gantt chart.</div>';
                return;
            }

            const minDate = new Date(Math.min(...allDates));
            const maxDate = new Date(Math.max(...allDates));

            // Add padding
            minDate.setDate(minDate.getDate() - 7);
            maxDate.setDate(maxDate.getDate() + 14);

            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
            const dayWidth = 3; // Compact for long timelines
            const timelineWidth = totalDays * dayWidth;
            const rowHeight = 32;

            // Build the split-pane Gantt layout
            let html = '<div style="display: flex; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white;">';

            // Left panel - Fixed task names
            html += '<div style="flex-shrink: 0; width: 200px; border-right: 2px solid #ddd; background: #fafafa;">';
            html += `<div style="height: ${rowHeight}px; padding: 8px; font-weight: 600; background: #f0f0f0; border-bottom: 2px solid #ddd; font-size: 12px;">Task / Milestone</div>`;

            tasks.filter(t => t.dueDate).forEach((task) => {
                const phase = task.phase || 'discovery';
                const phaseColors = { discovery: '#079fdb', documentation: '#0447bb', evaluation: '#5c74a7', selection: '#242c3c' };
                html += `<div style="height: ${rowHeight}px; padding: 6px 8px; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-bottom: 1px solid #eee; border-left: 3px solid ${phaseColors[phase] || '#079fdb'};" title="${task.name}">${task.name}</div>`;
            });

            milestones.filter(m => m.date).forEach(m => {
                const mTitle = m.title || m.name;
                html += `<div style="height: ${rowHeight}px; padding: 6px 8px; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-bottom: 1px solid #eee; border-left: 3px solid #764ba2; color: #764ba2; font-weight: 500;" title="${mTitle}">ðŸŽ¯ ${mTitle}</div>`;
            });
            html += '</div>';

            // Right panel - Scrollable timeline
            html += `<div style="flex: 1; overflow-x: auto;" id="ganttTimelineScroll">`;
            html += `<div style="min-width: ${timelineWidth}px;">`;

            // Month header
            html += `<div style="display: flex; height: ${rowHeight}px; background: #f0f0f0; border-bottom: 2px solid #ddd;">`;
            let currentMonth = new Date(minDate);
            while (currentMonth <= maxDate) {
                const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
                const monthEnd = new Date(Math.min(nextMonth.getTime() - 1, maxDate.getTime()));
                const daysInView = Math.ceil((monthEnd - currentMonth) / (1000 * 60 * 60 * 24)) + 1;
                const monthWidth = daysInView * dayWidth;

                html += `<div style="width: ${monthWidth}px; text-align: center; font-weight: 600; color: #333; padding: 8px 2px; border-right: 1px solid #ddd; font-size: 10px; white-space: nowrap; overflow: hidden;">
                    ${currentMonth.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })}
                </div>`;
                currentMonth = nextMonth;
            }
            html += '</div>';

            // Task bars
            tasks.filter(t => t.dueDate).forEach((task) => {
                const taskDate = new Date(task.dueDate);
                const dayOffset = Math.ceil((taskDate - minDate) / (1000 * 60 * 60 * 24));
                const phase = task.phase || 'discovery';
                const isDone = task.status === 'done';
                const barWidth = Math.max(dayWidth * 14, 50); // 2 weeks or minimum 50px

                html += `<div style="height: ${rowHeight}px; position: relative; border-bottom: 1px solid #eee; background: ${isDone ? '#f0fff0' : 'white'};">
                    <div class="gantt-bar ${phase}" style="position: absolute; top: 4px; left: ${dayOffset * dayWidth}px; width: ${barWidth}px; height: 24px; border-radius: 4px; opacity: ${isDone ? '0.6' : '1'}; ${isDone ? 'text-decoration: line-through;' : ''}">
                    </div>
                </div>`;
            });

            // Milestone markers
            milestones.filter(m => m.date).forEach(m => {
                const mDate = new Date(m.date);
                const dayOffset = Math.ceil((mDate - minDate) / (1000 * 60 * 60 * 24));

                html += `<div style="height: ${rowHeight}px; position: relative; border-bottom: 1px solid #eee;">
                    <div style="position: absolute; top: 6px; left: ${dayOffset * dayWidth - 10}px; width: 20px; height: 20px; background: #764ba2; transform: rotate(45deg);"></div>
                </div>`;
            });

            html += '</div></div></div>';

            // Add legend
            html += '<div style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px; display: flex; gap: 20px; flex-wrap: wrap; font-size: 11px;">';
            html += '<strong>Phases:</strong>';
            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #079fdb; border-radius: 2px; margin-right: 4px;"></span>Discovery</span>';
            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #0447bb; border-radius: 2px; margin-right: 4px;"></span>Documentation</span>';
            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #5c74a7; border-radius: 2px; margin-right: 4px;"></span>Evaluation</span>';
            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #242c3c; border-radius: 2px; margin-right: 4px;"></span>Selection</span>';
            html += '<span><span style="display: inline-block; width: 12px; height: 12px; background: #764ba2; transform: rotate(45deg); margin-right: 4px;"></span>Milestone</span>';
            html += '</div>';

            container.innerHTML = html;
        }

        // Document Repository Functions
        function renderDocuments() {
            const tree = document.getElementById('documentTree');
            if (!tree) return;

            if (!appState.documents || appState.documents.length === 0) {
                tree.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No documents loaded.</div>';
                return;
            }

            let html = '';
            appState.documents.forEach(folder => {
                const isExpanded = folder.expanded !== false;
                html += `
                    <div class="folder-item">
                        <div class="folder-header" onclick="toggleFolder('${folder.id}')">
                            <span class="folder-icon">${isExpanded ? 'ðŸ“‚' : 'ðŸ“'}</span>
                            <span class="folder-name">${folder.name}</span>
                            <span class="folder-count">${folder.documents.length} files</span>
                            <span class="folder-toggle">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                        </div>
                        <div class="folder-contents" style="display: ${isExpanded ? 'block' : 'none'};">`;

                folder.documents.forEach(doc => {
                    const statusClass = doc.status === 'final' ? 'final' :
                                       doc.status === 'draft' ? 'draft' : 'template';
                    const icon = doc.name.endsWith('.docx') ? 'ðŸ“„' :
                                doc.name.endsWith('.xlsx') ? 'ðŸ“Š' :
                                doc.name.endsWith('.pptx') ? 'ðŸ“½ï¸' :
                                doc.name.endsWith('.pdf') ? 'ðŸ“•' : 'ðŸ“„';

                    // Check if document has a downloadable file
                    const hasFile = doc.fileUrl || doc.fileData || (appState.uploadedFiles && appState.uploadedFiles[doc.id]);

                    html += `
                        <div class="document-item">
                            <span class="doc-icon">${icon}</span>
                            <span class="doc-name">${doc.name}</span>
                            <span class="doc-status ${statusClass}">${doc.status}</span>
                            <div class="doc-actions">
                                ${hasFile ? `<button class="btn btn-small btn-primary" onclick="downloadDocument('${folder.id}', ${doc.id})" title="Download">ðŸ“¥</button>` : ''}
                                <button class="btn btn-small" onclick="editDocument('${folder.id}', ${doc.id})" title="Edit">âœï¸</button>
                                <button class="btn btn-small btn-danger" onclick="deleteDocument('${folder.id}', ${doc.id})" title="Delete">ðŸ—‘ï¸</button>
                            </div>
                        </div>`;
                });

                html += `</div></div>`;
            });

            // Add Meeting Notes section if there are any meeting notes with files
            const meetingNotesWithFiles = (appState.meetingNotes || []).filter(note => note.hasFile);
            if (meetingNotesWithFiles.length > 0) {
                const isExpanded = appState.meetingNotesExpanded !== false;
                html += `
                    <div class="folder-item">
                        <div class="folder-header" onclick="toggleMeetingNotesFolder()" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                            <span class="folder-icon">${isExpanded ? 'ðŸ“‚' : 'ðŸ“'}</span>
                            <span class="folder-name">6. Meeting Notes</span>
                            <span class="folder-count">${meetingNotesWithFiles.length} files</span>
                            <span class="folder-toggle">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                        </div>
                        <div class="folder-contents" style="display: ${isExpanded ? 'block' : 'none'};">`;

                meetingNotesWithFiles.forEach(note => {
                    const icon = note.fileName.endsWith('.docx') ? 'ðŸ“„' :
                                note.fileName.endsWith('.xlsx') ? 'ðŸ“Š' :
                                note.fileName.endsWith('.pptx') ? 'ðŸ“½ï¸' :
                                note.fileName.endsWith('.pdf') ? 'ðŸ“•' : 'ðŸ“„';
                    const meeting = note.meetingId ? appState.meetings.find(m => m.id === note.meetingId) : null;
                    const meetingInfo = meeting ? ` (${meeting.title})` : '';

                    html += `
                        <div class="document-item">
                            <span class="doc-icon">${icon}</span>
                            <span class="doc-name">${note.title}${meetingInfo}</span>
                            <span class="doc-status draft">${note.date}</span>
                            <div class="doc-actions">
                                <button class="btn btn-small btn-primary" onclick="downloadMeetingNoteFromDocs(${note.id})" title="Download">ðŸ“¥</button>
                            </div>
                        </div>`;
                });

                html += `</div></div>`;
            }

            tree.innerHTML = html;
        }

        function toggleMeetingNotesFolder() {
            appState.meetingNotesExpanded = !appState.meetingNotesExpanded;
            renderDocuments();
        }

        function downloadMeetingNoteFromDocs(noteId) {
            const note = appState.meetingNotes.find(n => n.id === noteId);
            if (note && note.fileUrl) {
                window.open(note.fileUrl, '_blank');
            } else if (note && note.fileData) {
                const link = document.createElement('a');
                link.href = note.fileData;
                link.download = note.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function toggleFolder(folderId) {
            const folder = appState.documents.find(f => f.id === folderId);
            if (folder) {
                folder.expanded = !folder.expanded;
                renderDocuments();
            }
        }

        function addDocument() {
            const folderOptions = appState.documents.map(f => f.name).join('\n');
            const folderName = prompt('Select folder (enter number 1-5):\n1. Discovery & Strategy\n2. RFP Documentation\n3. Evaluation & Selection\n4. Final Selection & Award\n5. Programme Governance');

            if (!folderName) return;

            const folderIndex = parseInt(folderName) - 1;
            if (isNaN(folderIndex) || folderIndex < 0 || folderIndex >= appState.documents.length) {
                alert('Invalid folder selection');
                return;
            }

            const docName = prompt('Document name (include extension, e.g., "Report.docx"):');
            if (!docName) return;

            const status = prompt('Status (template, draft, or final):') || 'draft';

            const folder = appState.documents[folderIndex];
            const newId = Math.max(...folder.documents.map(d => d.id), 0) + 1;

            folder.documents.push({
                id: newId,
                name: docName,
                status: status,
                folder: folder.id
            });

            folder.expanded = true;
            saveState();
            renderDocuments();
        }

        function editDocument(folderId, docId) {
            const folder = appState.documents.find(f => f.id === folderId);
            if (!folder) return;

            const doc = folder.documents.find(d => d.id === docId);
            if (!doc) return;

            const newName = prompt('Document name:', doc.name);
            if (newName) doc.name = newName;

            const newStatus = prompt('Status (template, draft, final):', doc.status);
            if (newStatus && ['template', 'draft', 'final'].includes(newStatus)) {
                doc.status = newStatus;
            }

            saveState();
            renderDocuments();
        }

        function downloadDocument(folderId, docId) {
            const folder = appState.documents.find(f => f.id === folderId);
            if (!folder) {
                showToast('Folder not found', 'error');
                return;
            }

            const doc = folder.documents.find(d => d.id === docId);
            if (!doc) {
                showToast('Document not found', 'error');
                return;
            }

            // Get file URL from various possible sources (new format or legacy)
            const fileUrl = doc.fileUrl || doc.fileData || (appState.uploadedFiles && appState.uploadedFiles[docId]);

            if (!fileUrl) {
                showToast('No file available for download', 'error');
                return;
            }

            // Use the helper function for downloading
            downloadFile(fileUrl, doc.name);
        }

        async function deleteDocument(folderId, docId) {
            if (!confirm('Delete this document?')) return;

            const folder = appState.documents.find(f => f.id === folderId);
            if (folder) {
                const doc = folder.documents.find(d => d.id === docId);

                // Delete file from Vercel Blob if it's cloud-stored
                if (doc?.fileUrl && doc?.isCloudStored) {
                    await deleteFromVercelBlob(doc.fileUrl);
                }

                // Also clean up from uploadedFiles
                if (appState.uploadedFiles && appState.uploadedFiles[docId]) {
                    const fileUrl = appState.uploadedFiles[docId];
                    if (doc?.isCloudStored && !fileUrl.startsWith('data:')) {
                        await deleteFromVercelBlob(fileUrl);
                    }
                    delete appState.uploadedFiles[docId];
                }

                folder.documents = folder.documents.filter(d => d.id !== docId);
                saveState();
                renderDocuments();
                showToast('Document deleted', 'success');
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Decision Log Functions
        function openDecisionModal() {
            document.getElementById('decisionTitle').value = '';
            document.getElementById('decisionDescription').value = '';
            document.getElementById('decisionRationale').value = '';
            document.getElementById('decisionOwner').value = '';
            document.getElementById('decisionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('decisionStatus').value = 'pending';
            document.getElementById('decisionModal').style.display = 'block';
        }

        function saveDecision() {
            const title = document.getElementById('decisionTitle').value.trim();
            if (!title) {
                showToast('Please enter decision title', 'error');
                return;
            }

            const newId = Math.max(...(appState.decisions || []).map(d => d.id), 0) + 1;
            if (!appState.decisions) appState.decisions = [];

            appState.decisions.push({
                id: newId,
                title: sanitizeHTML(title),
                description: sanitizeHTML(document.getElementById('decisionDescription').value.trim()),
                rationale: sanitizeHTML(document.getElementById('decisionRationale').value.trim()),
                owner: sanitizeHTML(document.getElementById('decisionOwner').value.trim()),
                date: document.getElementById('decisionDate').value,
                status: document.getElementById('decisionStatus').value
            });

            saveState();
            renderDecisionList();
            closeModal('decisionModal');
            showToast('Decision saved', 'success');
        }

        function renderDecisionList() {
            const el = document.getElementById('decisionList');
            if (!el) return;

            const decisions = appState.decisions || [];
            if (decisions.length === 0) {
                el.innerHTML = '<p style="color: var(--gray-700);">No decisions logged yet.</p>';
                return;
            }

            el.innerHTML = decisions.map(d => `
                <div class="decision-card ${d.status}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="font-size: 1.1em;">${sanitizeHTML(d.title)}</strong>
                        <span class="vendor-status status-${d.status === 'approved' ? 'warm' : d.status === 'rejected' ? 'longlist' : 'shortlist'}">
                            ${d.status === 'approved' ? 'âœ“ Approved' : d.status === 'rejected' ? 'âœ— Rejected' : 'â³ Pending'}
                        </span>
                    </div>
                    <p style="margin: 8px 0;"><strong>Description:</strong> ${sanitizeHTML(d.description) || 'N/A'}</p>
                    <p style="margin: 8px 0;"><strong>Rationale:</strong> ${sanitizeHTML(d.rationale) || 'N/A'}</p>
                    <p style="margin: 8px 0; font-size: 0.9em; color: var(--gray-700);">
                        <strong>Decision Maker:</strong> ${sanitizeHTML(d.owner) || 'N/A'} | <strong>Date:</strong> ${formatDate(d.date)}
                    </p>
                    <button class="btn btn-small btn-danger" onclick="deleteDecision(${d.id})">Delete</button>
                </div>
            `).join('');
        }

        function deleteDecision(id) {
            showConfirm('Delete this decision?', () => {
                appState.decisions = appState.decisions.filter(d => d.id !== id);
                saveState();
                renderDecisionList();
                showToast('Decision deleted', 'success');
            });
        }

        // Milestone Modal Functions
        function openMilestoneModal() {
            document.getElementById('milestoneTitle').value = '';
            document.getElementById('milestoneDate').value = '';
            document.getElementById('milestoneModal').style.display = 'block';
        }

        function saveMilestone() {
            const title = document.getElementById('milestoneTitle').value.trim();
            if (!title) {
                showToast('Please enter milestone title', 'error');
                return;
            }

            const newId = Math.max(...appState.milestones.map(m => m.id), 0) + 1;
            appState.milestones.push({
                id: newId,
                title: sanitizeHTML(title),
                date: document.getElementById('milestoneDate').value,
                status: 'notstarted'
            });

            saveState();
            renderMilestones();
            renderCalendar();
            renderGantt();
            closeModal('milestoneModal');
            showToast('Milestone added', 'success');
        }

        // Stakeholder Modal Functions
        function openStakeholderModal() {
            document.getElementById('stakeholderName').value = '';
            document.getElementById('stakeholderRole').value = '';
            document.getElementById('stakeholderDept').value = '';
            document.getElementById('stakeholderInfluence').value = 'high';
            document.getElementById('stakeholderInterest').value = 'high';
            document.getElementById('stakeholderNotes').value = '';
            document.getElementById('stakeholderModal').style.display = 'block';
        }

        function saveStakeholder() {
            const name = document.getElementById('stakeholderName').value.trim();
            if (!name) {
                showToast('Please enter stakeholder name', 'error');
                return;
            }

            const newId = Math.max(...appState.stakeholders.map(s => s.id), 0) + 1;
            appState.stakeholders.push({
                id: newId,
                name: sanitizeHTML(name),
                role: sanitizeHTML(document.getElementById('stakeholderRole').value.trim()) || 'Stakeholder',
                department: sanitizeHTML(document.getElementById('stakeholderDept').value.trim()),
                email: '',
                influence: document.getElementById('stakeholderInfluence').value,
                interest: document.getElementById('stakeholderInterest').value,
                notes: sanitizeHTML(document.getElementById('stakeholderNotes').value.trim())
            });

            saveState();
            renderStakeholders();
            renderRaciMatrix();
            closeModal('stakeholderModal');
            showToast('Stakeholder added', 'success');
        }

        // Vendor Scoring Functions
        function renderScoringTable() {
            const header = document.getElementById('scoringHeader');
            const body = document.getElementById('scoringBody');
            if (!header || !body) return;

            const shortlistVendors = appState.vendors.filter(v =>
                ['warm', 'shortlist', 'finalist', 'winner'].includes(v.status)
            );

            if (shortlistVendors.length === 0) {
                header.innerHTML = '<tr><th>No vendors in shortlist</th></tr>';
                body.innerHTML = '<tr><td>Move vendors to Warm Lead, Shortlist, or Finalist status to score them.</td></tr>';
                return;
            }

            // Header
            header.innerHTML = `<tr>
                <th>Criterion</th>
                <th>Weight</th>
                ${shortlistVendors.map(v => `<th style="min-width:100px;">${sanitizeHTML(v.name)}</th>`).join('')}
            </tr>`;

            // Body
            body.innerHTML = appState.evaluation.map(c => `
                <tr>
                    <td><strong>${sanitizeHTML(c.criterion)}</strong></td>
                    <td>${c.weight}%</td>
                    ${shortlistVendors.map(v => {
                        const key = `${v.id}-${c.id}`;
                        const score = (appState.vendorScores || {})[key] || '';
                        return `<td>
                            <input type="number" min="0" max="10" class="weight-input"
                                value="${score}" data-vendor="${v.id}" data-criterion="${c.id}"
                                onchange="updateScore(${v.id}, ${c.id}, this.value)"
                                style="width:60px;">
                        </td>`;
                    }).join('')}
                </tr>
            `).join('') + `
                <tr style="background: var(--gray-100); font-weight: 600;">
                    <td>Weighted Total</td>
                    <td>100%</td>
                    ${shortlistVendors.map(v => `<td id="total-${v.id}">${calculateVendorScore(v.id).toFixed(1)}</td>`).join('')}
                </tr>
            `;

            renderScoringSummary(shortlistVendors);
        }

        function updateScore(vendorId, criterionId, value) {
            if (!appState.vendorScores) appState.vendorScores = {};
            const key = `${vendorId}-${criterionId}`;
            const score = parseInt(value) || 0;
            appState.vendorScores[key] = Math.min(10, Math.max(0, score));
            saveState();

            const totalEl = document.getElementById(`total-${vendorId}`);
            if (totalEl) totalEl.textContent = calculateVendorScore(vendorId).toFixed(1);

            renderScoringSummary(appState.vendors.filter(v =>
                ['warm', 'shortlist', 'finalist', 'winner'].includes(v.status)
            ));
        }

        function calculateVendorScore(vendorId) {
            let total = 0;
            const totalWeight = appState.evaluation.reduce((sum, c) => sum + c.weight, 0);

            appState.evaluation.forEach(c => {
                const key = `${vendorId}-${c.id}`;
                const score = (appState.vendorScores || {})[key] || 0;
                total += (score / 10) * c.weight;
            });

            return totalWeight > 0 ? (total / totalWeight) * 100 : 0;
        }

        function renderScoringSummary(vendors) {
            const el = document.getElementById('scoringSummary');
            if (!el || vendors.length === 0) return;

            const ranked = vendors.map(v => ({
                ...v,
                score: calculateVendorScore(v.id)
            })).sort((a, b) => b.score - a.score);

            el.innerHTML = `
                <h3 style="margin-bottom: 15px;">Vendor Ranking</h3>
                <div class="vendor-grid">
                    ${ranked.map((v, i) => `
                        <div class="vendor-card" style="border-left: 4px solid ${i === 0 ? 'var(--success)' : i === 1 ? 'var(--warning)' : 'var(--gray-200)'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="vendor-name">#${i + 1} ${sanitizeHTML(v.name)}</span>
                                <span class="score-badge ${v.score >= 70 ? 'score-high' : v.score >= 40 ? 'score-medium' : 'score-low'}">
                                    ${v.score.toFixed(1)}%
                                </span>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray-700);">
                                ${v.tier} | ${v.status}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function saveScores() {
            saveState();
            showToast('Scores saved successfully', 'success');
        }

        function generateScoreReport() {
            const shortlistVendors = appState.vendors.filter(v =>
                ['warm', 'shortlist', 'finalist', 'winner'].includes(v.status)
            );

            const ranked = shortlistVendors.map(v => ({
                ...v,
                score: calculateVendorScore(v.id)
            })).sort((a, b) => b.score - a.score);

            const html = `
                <h2>Vendor Scoring Report</h2>
                <p><strong>Generated:</strong> ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p>

                <h3 style="margin-top: 20px;">Ranking Summary</h3>
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Vendor</th>
                            <th>Tier</th>
                            <th>Score</th>
                            <th>Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ranked.map((v, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td><strong>${sanitizeHTML(v.name)}</strong></td>
                                <td>${v.tier}</td>
                                <td>${v.score.toFixed(1)}%</td>
                                <td>${i === 0 ? 'â­ Recommended' : i < 3 ? 'Shortlist' : 'Consider'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <h3 style="margin-top: 20px;">Detailed Scores by Criterion</h3>
                <table class="evaluation-table">
                    <thead>
                        <tr>
                            <th>Criterion</th>
                            <th>Weight</th>
                            ${ranked.map(v => `<th>${sanitizeHTML(v.name)}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.evaluation.map(c => `
                            <tr>
                                <td>${sanitizeHTML(c.criterion)}</td>
                                <td>${c.weight}%</td>
                                ${ranked.map(v => {
                                    const key = `${v.id}-${c.id}`;
                                    const score = (appState.vendorScores || {})[key] || 0;
                                    return `<td>${score}/10</td>`;
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('reportOutput').innerHTML = html;
        }

        // Import/Export Functions
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Validate basic structure
                    if (!data.tasks || !data.vendors) {
                        throw new Error('Invalid data format');
                    }

                    // Merge imported data with appState
                    Object.keys(data).forEach(key => {
                        if (appState.hasOwnProperty(key)) {
                            appState[key] = data[key];
                        }
                    });

                    // Restore date objects
                    appState.startDate = new Date(appState.startDate);
                    appState.goLiveDate = new Date(appState.goLiveDate);
                    appState.calendarMonth = new Date(appState.calendarMonth || '2025-12-01');

                    saveState();
                    renderAll();
                    updateDashboard();
                    showToast('Data imported successfully', 'success');
                } catch (err) {
                    showToast('Error importing data: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function resetToDefaults() {
            showConfirm('Reset all data to defaults? This cannot be undone.', () => {
                localStorage.removeItem('hexagonRFP');
                initializeFromDefault();
                renderAll();
                updateDashboard();
                showToast('Data reset to defaults', 'success');
            });
        }

        // Update Milestones button
        function addMilestone() {
            openMilestoneModal();
        }

        // Update Stakeholder button
        function addStakeholder() {
            openStakeholderModal();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Keyboard navigation for tabs
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            }
        });

        // ==========================================
        // MEETINGS FUNCTIONS
        // ==========================================

        function openMeetingModal() {
            document.getElementById('meetingTitle').value = '';
            document.getElementById('meetingDate').value = '';
            document.getElementById('meetingTime').value = '';
            document.getElementById('meetingDuration').value = '1';
            document.getElementById('meetingLocation').value = '';
            document.getElementById('meetingAttendees').value = '';
            document.getElementById('meetingAgenda').value = '';
            document.getElementById('meetingType').value = 'internal';
            document.getElementById('meetingModalTitle').textContent = 'Add New Meeting';
            document.getElementById('meetingModal').style.display = 'block';
        }

        function saveMeeting() {
            const title = document.getElementById('meetingTitle').value.trim();
            const date = document.getElementById('meetingDate').value;

            if (!title || !date) {
                showToast('Please enter meeting title and date', 'error');
                return;
            }

            const newId = Math.max(...(appState.meetings || []).map(m => m.id), 0) + 1;
            if (!appState.meetings) appState.meetings = [];

            appState.meetings.push({
                id: newId,
                title: sanitizeHTML(title),
                date: date,
                time: document.getElementById('meetingTime').value || '09:00',
                duration: parseFloat(document.getElementById('meetingDuration').value) || 1,
                location: sanitizeHTML(document.getElementById('meetingLocation').value.trim()),
                attendees: sanitizeHTML(document.getElementById('meetingAttendees').value.trim()),
                agenda: sanitizeHTML(document.getElementById('meetingAgenda').value.trim()),
                type: document.getElementById('meetingType').value
            });

            saveState();
            renderMeetingCalendar();
            renderMeetingsList();
            closeModal('meetingModal');
            showToast('Meeting added successfully', 'success');
        }

        function deleteMeeting(id) {
            showConfirm('Delete this meeting?', () => {
                appState.meetings = appState.meetings.filter(m => m.id !== id);
                saveState();
                renderMeetingCalendar();
                renderMeetingsList();
                showToast('Meeting deleted', 'success');
            });
        }

        function changeMeetingMonth(delta) {
            if (!appState.meetingCalendarMonth) {
                appState.meetingCalendarMonth = new Date('2025-12-01');
            }
            const current = new Date(appState.meetingCalendarMonth);
            current.setMonth(current.getMonth() + delta);
            appState.meetingCalendarMonth = current;
            renderMeetingCalendar();
        }

        function renderMeetingCalendar() {
            const container = document.getElementById('meetingCalendarGrid');
            const titleEl = document.getElementById('meetingCalendarTitle');
            if (!container || !titleEl) return;

            if (!appState.meetingCalendarMonth) {
                appState.meetingCalendarMonth = new Date('2025-12-01');
            }

            const currentMonth = new Date(appState.meetingCalendarMonth);
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            titleEl.textContent = currentMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

            // Clear existing days (keep headers)
            const headers = container.querySelectorAll('.calendar-header');
            container.innerHTML = '';
            headers.forEach(h => container.appendChild(h.cloneNode(true)));

            // Add days with headers
            const headerHTML = `
                <div class="calendar-header">Sun</div>
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
            `;
            container.innerHTML = headerHTML;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();

            // Empty cells for days before month starts
            for (let i = 0; i < startDayOfWeek; i++) {
                container.innerHTML += `<div class="calendar-day empty"></div>`;
            }

            // Days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayMeetings = (appState.meetings || []).filter(m => m.date === dateStr);

                let eventsHtml = '';
                dayMeetings.forEach(m => {
                    const typeColor = m.type === 'steering' ? '#dc3545' :
                                     m.type === 'vendor' ? '#28a745' :
                                     m.type === 'workshop' ? '#ffc107' :
                                     m.type === 'review' ? '#17a2b8' : '#764ba2';
                    eventsHtml += `<div class="calendar-event" style="background: ${typeColor}20; color: ${typeColor}; font-size: 10px; padding: 2px 4px; margin: 1px 0; border-radius: 3px; cursor: pointer;" title="${m.title} - ${m.time}">${m.title.substring(0, 15)}${m.title.length > 15 ? '...' : ''}</div>`;
                });

                container.innerHTML += `
                    <div class="calendar-day">
                        <div class="calendar-date">${day}</div>
                        ${eventsHtml}
                    </div>
                `;
            }
        }

        function renderMeetingsList() {
            const el = document.getElementById('meetingsList');
            if (!el) return;

            const meetings = (appState.meetings || []).sort((a, b) => new Date(a.date) - new Date(b.date));
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcoming = meetings.filter(m => new Date(m.date) >= today);
            const past = meetings.filter(m => new Date(m.date) < today);

            if (meetings.length === 0) {
                el.innerHTML = '<p style="padding: 20px; color: var(--gray-700);">No meetings scheduled. Click "Add Meeting" to create one.</p>';
                return;
            }

            let html = '';
            if (upcoming.length > 0) {
                html += '<h4 style="margin-bottom: 15px; color: var(--primary);">Upcoming Meetings</h4>';
                html += upcoming.map(m => renderMeetingCard(m, false)).join('');
            }
            if (past.length > 0) {
                html += '<h4 style="margin: 20px 0 15px; color: var(--gray-700);">Past Meetings</h4>';
                html += past.slice(0, 5).map(m => renderMeetingCard(m, true)).join('');
            }

            el.innerHTML = html;
        }

        function renderMeetingCard(m, isPast) {
            const typeLabels = {
                'internal': 'Internal',
                'vendor': 'Vendor',
                'steering': 'Steering Committee',
                'workshop': 'Workshop',
                'review': 'Review'
            };
            const typeColors = {
                'internal': '#764ba2',
                'vendor': '#28a745',
                'steering': '#dc3545',
                'workshop': '#ffc107',
                'review': '#17a2b8'
            };

            return `
                <div class="meeting-card" style="background: ${isPast ? 'var(--gray-50)' : 'white'}; border: 1px solid var(--gray-200); border-left: 4px solid ${typeColors[m.type] || '#764ba2'}; border-radius: 8px; padding: 15px; margin-bottom: 10px; ${isPast ? 'opacity: 0.7;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong style="font-size: 1.1em;">${sanitizeHTML(m.title)}</strong>
                            <span style="margin-left: 10px; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; background: ${typeColors[m.type]}20; color: ${typeColors[m.type]};">${typeLabels[m.type] || 'Meeting'}</span>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="deleteMeeting(${m.id})">Delete</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray-700);">
                        <p><strong>Date:</strong> ${formatDate(m.date)} at ${m.time || 'TBD'} (${m.duration || 1}h)</p>
                        <p><strong>Location:</strong> ${m.location || 'TBD'}</p>
                        <p><strong>Attendees:</strong> ${m.attendees || 'TBD'}</p>
                        ${m.agenda ? `<p style="margin-top: 8px;"><strong>Agenda:</strong> ${m.agenda}</p>` : ''}
                    </div>
                </div>
            `;
        }

        // ==========================================
        // MEETING NOTES FUNCTIONS
        // ==========================================

        function openMeetingNotesModal() {
            document.getElementById('notesTitle').value = '';
            document.getElementById('notesContent').value = '';
            document.getElementById('notesDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('notesFile').value = '';

            // Populate meetings dropdown
            const select = document.getElementById('notesMeeting');
            select.innerHTML = '<option value="">-- Select Meeting (Optional) --</option>';
            (appState.meetings || []).forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.title} (${formatDate(m.date)})</option>`;
            });

            document.getElementById('meetingNotesModal').style.display = 'block';
        }

        async function saveMeetingNotes() {
            const title = document.getElementById('notesTitle').value.trim();
            if (!title) {
                showToast('Please enter a title for the notes', 'error');
                return;
            }

            const fileInput = document.getElementById('notesFile');
            const content = document.getElementById('notesContent').value.trim();

            if (!content && (!fileInput.files || fileInput.files.length === 0)) {
                showToast('Please enter notes or upload a file', 'error');
                return;
            }

            const newId = Math.max(...(appState.meetingNotes || []).map(n => n.id), 0) + 1;
            if (!appState.meetingNotes) appState.meetingNotes = [];

            const note = {
                id: newId,
                title: sanitizeHTML(title),
                meetingId: document.getElementById('notesMeeting').value || null,
                date: document.getElementById('notesDate').value,
                content: sanitizeHTML(content),
                hasFile: false,
                fileName: ''
            };

            // Handle file upload
            if (fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                showToast('Uploading file...', 'info');

                try {
                    // Upload to Vercel Blob (or base64 fallback for local dev)
                    const uploadResult = await uploadToVercelBlob(file, 'meeting-notes', 'meeting-note');

                    note.hasFile = true;
                    note.fileName = file.name;
                    note.fileUrl = uploadResult.url;  // Store URL instead of base64
                    note.fileData = uploadResult.isBase64 ? uploadResult.url : null; // Keep base64 for backwards compatibility
                    note.isCloudStored = !uploadResult.isBase64;

                    appState.meetingNotes.push(note);
                    saveState();
                    renderMeetingNotesList();
                    closeModal('meetingNotesModal');
                    showToast('Meeting notes saved', 'success');
                } catch (error) {
                    console.error('Meeting notes upload error:', error);
                    console.error('Full error object:', error);
                    // Provide more specific error messages
                    let userMessage = error.message || 'Unknown error';
                    if (error.message && error.message.includes('Failed to fetch')) {
                        userMessage = 'Network error - could not reach server. Please check your connection.';
                    } else if (error.message && error.message.includes('413')) {
                        userMessage = 'File is too large. Please try a smaller file.';
                    }
                    showToast(`Error uploading file: ${userMessage}`, 'error');
                }
            } else {
                appState.meetingNotes.push(note);
                saveState();
                renderMeetingNotesList();
                closeModal('meetingNotesModal');
                showToast('Meeting notes saved', 'success');
            }
        }

        function deleteMeetingNotes(id) {
            showConfirm('Delete these meeting notes?', async () => {
                const note = appState.meetingNotes.find(n => n.id === id);

                // Delete file from Vercel Blob if it's cloud-stored
                if (note?.fileUrl && note?.isCloudStored) {
                    await deleteFromVercelBlob(note.fileUrl);
                }

                appState.meetingNotes = appState.meetingNotes.filter(n => n.id !== id);
                saveState();
                renderMeetingNotesList();
                showToast('Notes deleted', 'success');
            });
        }

        function renderMeetingNotesList() {
            const el = document.getElementById('meetingNotesList');
            if (!el) return;

            const notes = (appState.meetingNotes || []).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (notes.length === 0) {
                el.innerHTML = '<p style="padding: 20px; color: var(--gray-700);">No meeting notes uploaded yet. Click "Upload Notes" to add notes.</p>';
                return;
            }

            el.innerHTML = notes.map(n => {
                const meeting = n.meetingId ? (appState.meetings || []).find(m => m.id == n.meetingId) : null;
                return `
                    <div class="notes-card" style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <strong style="font-size: 1.1em;">${sanitizeHTML(n.title)}</strong>
                                ${n.hasFile ? '<span style="margin-left: 10px; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; background: #e3f2fd; color: #1976d2;">ðŸ“Ž File Attached</span>' : ''}
                            </div>
                            <button class="btn btn-small btn-danger" onclick="deleteMeetingNotes(${n.id})">Delete</button>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: var(--gray-700);">
                            <p><strong>Date:</strong> ${formatDate(n.date)}</p>
                            ${meeting ? `<p><strong>Related Meeting:</strong> ${meeting.title}</p>` : ''}
                            ${n.content ? `<div style="margin-top: 10px; padding: 10px; background: var(--gray-50); border-radius: 4px; white-space: pre-wrap;">${sanitizeHTML(n.content)}</div>` : ''}
                            ${n.hasFile ? `<p style="margin-top: 10px;"><button class="btn btn-small btn-primary" onclick="downloadNoteFile(${n.id})">ðŸ“¥ Download ${n.fileName}</button></p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function downloadNoteFile(noteId) {
            const note = appState.meetingNotes.find(n => n.id === noteId);
            // Support both new fileUrl and legacy fileData
            const fileUrl = note?.fileUrl || note?.fileData;
            if (!note || !fileUrl) {
                showToast('File not found', 'error');
                return;
            }

            // Use the helper function for downloading
            downloadFile(fileUrl, note.fileName);
        }

        // ==========================================
        // DOCUMENT UPLOAD FUNCTIONS
        // ==========================================

        function openUploadModal() {
            document.getElementById('uploadFile').value = '';
            document.getElementById('uploadFolder').value = 'discovery';
            document.getElementById('uploadStatus').value = 'draft';
            document.getElementById('uploadModal').style.display = 'block';
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('uploadFile');
            const folderId = document.getElementById('uploadFolder').value;
            const status = document.getElementById('uploadStatus').value;

            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Please select a file to upload', 'error');
                return;
            }

            const file = fileInput.files[0];
            const maxSize = 50 * 1024 * 1024; // 50MB limit with Vercel Blob

            if (file.size > maxSize) {
                showToast('File size must be less than 50MB', 'error');
                return;
            }

            const folder = appState.documents.find(f => f.id === folderId);
            if (!folder) {
                showToast('Invalid folder selected', 'error');
                return;
            }

            // Show uploading indicator
            showToast('Uploading document...', 'info');

            try {
                // Upload to Vercel Blob (or base64 fallback for local dev)
                const uploadResult = await uploadToVercelBlob(file, folderId, 'document');

                const newId = Math.max(...folder.documents.map(d => d.id), 100) + 1;

                folder.documents.push({
                    id: newId,
                    name: file.name,
                    status: status,
                    folder: folderId,
                    fileUrl: uploadResult.url,  // Store URL instead of base64
                    fileData: uploadResult.isBase64 ? uploadResult.url : null, // Keep base64 for backwards compatibility
                    uploadDate: new Date().toISOString(),
                    isCloudStored: !uploadResult.isBase64
                });

                // Store file reference (URL or base64) separately
                if (!appState.uploadedFiles) appState.uploadedFiles = {};
                appState.uploadedFiles[newId] = uploadResult.url;

                folder.expanded = true;
                saveState();
                renderDocuments();
                closeModal('uploadModal');
                showToast(`Document "${file.name}" uploaded successfully`, 'success');
            } catch (error) {
                console.error('Upload error:', error);
                showToast(`Error uploading file: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // REPORT EXPORT FUNCTIONS
        // ==========================================

        function exportToWord() {
            const reportContent = document.getElementById('reportOutput').innerHTML;
            if (!reportContent || reportContent.trim() === '') {
                showToast('Please generate a report first', 'error');
                return;
            }

            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>Hexagon SAP AMS RFP Report</title>
                    <style>
                        body { font-family: Calibri, Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        h1, h2, h3 { color: #0447bb; }
                        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #079fdb; color: white; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .logo { color: #079fdb; font-size: 24px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">HEXAGON</div>
                        <p>SAP AMS RFP Programme</p>
                    </div>
                    ${reportContent}
                    <hr style="margin-top: 40px;">
                    <p style="font-size: 0.9em; color: #666;">Generated on ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                </body>
                </html>
            `;

            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Hexagon-RFP-Report-${new Date().toISOString().split('T')[0]}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Report exported to Word format', 'success');
        }

        function exportToPowerPoint() {
            const reportContent = document.getElementById('reportOutput').innerHTML;
            if (!reportContent || reportContent.trim() === '') {
                showToast('Please generate a report first', 'error');
                return;
            }

            // Create a simple HTML-based presentation
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>Hexagon SAP AMS RFP Presentation</title>
                    <style>
                        body { font-family: Calibri, Arial, sans-serif; margin: 0; padding: 0; }
                        .slide {
                            width: 960px;
                            height: 720px;
                            padding: 60px;
                            box-sizing: border-box;
                            page-break-after: always;
                            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                            position: relative;
                        }
                        .title-slide {
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            text-align: center;
                            background: linear-gradient(135deg, #079fdb 0%, #0447bb 100%);
                            color: white;
                        }
                        .title-slide h1 { font-size: 48px; margin-bottom: 20px; }
                        .title-slide p { font-size: 24px; }
                        h1, h2, h3 { color: #0447bb; }
                        .content-slide h2 { font-size: 32px; margin-bottom: 30px; border-bottom: 3px solid #079fdb; padding-bottom: 10px; }
                        table { border-collapse: collapse; width: 100%; margin: 20px 0; font-size: 14px; }
                        th, td { border: 1px solid #ddd; padding: 8px; }
                        th { background-color: #079fdb; color: white; }
                        .footer { position: absolute; bottom: 20px; right: 40px; font-size: 12px; color: #666; }
                        .logo { font-size: 18px; font-weight: bold; color: #079fdb; position: absolute; bottom: 20px; left: 40px; }
                        @media print { .slide { page-break-after: always; } }
                    </style>
                </head>
                <body>
                    <div class="slide title-slide">
                        <h1>HEXAGON</h1>
                        <p>SAP AMS RFP Programme Report</p>
                        <p style="margin-top: 40px; font-size: 18px;">${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                    </div>
                    <div class="slide content-slide">
                        ${reportContent}
                        <div class="logo">HEXAGON</div>
                        <div class="footer">SAP AMS RFP Programme</div>
                    </div>
                </body>
                </html>
            `;

            const blob = new Blob([htmlContent], { type: 'application/vnd.ms-powerpoint' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Hexagon-RFP-Presentation-${new Date().toISOString().split('T')[0]}.ppt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Report exported to PowerPoint format', 'success');
        }

        function printReport() {
            const reportContent = document.getElementById('reportOutput').innerHTML;
            if (!reportContent || reportContent.trim() === '') {
                showToast('Please generate a report first', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Hexagon SAP AMS RFP Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        h1, h2, h3 { color: #0447bb; }
                        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #079fdb; color: white; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: #079fdb;">HEXAGON</h1>
                        <p>SAP AMS RFP Programme Report</p>
                    </div>
                    ${reportContent}
                    <hr style="margin-top: 40px;">
                    <p style="font-size: 0.9em; color: #666;">Printed on ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
